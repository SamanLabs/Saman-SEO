---
phase: 09-variable-products
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Schema/Types/class-product-schema.php
autonomous: true

must_haves:
  truths:
    - "Variable products output AggregateOffer instead of single Offer"
    - "AggregateOffer includes lowPrice from minimum variation price"
    - "AggregateOffer includes highPrice from maximum variation price"
    - "AggregateOffer shows InStock if ANY variation is in stock"
  artifacts:
    - path: "includes/Schema/Types/class-product-schema.php"
      provides: "AggregateOffer building for variable products"
      contains: "build_aggregate_offer"
      exports: ["build_aggregate_offer"]
  key_links:
    - from: "includes/Schema/Types/class-product-schema.php"
      to: "WC_Product_Variable"
      via: "is_type('variable') check in generate()"
      pattern: "is_type.*variable"
    - from: "build_aggregate_offer()"
      to: "get_variation_price()"
      via: "WooCommerce variation price API"
      pattern: "get_variation_price"
---

<objective>
Implement AggregateOffer schema for WooCommerce variable products, outputting price ranges (lowPrice/highPrice) and aggregated availability.

Purpose: Enable Google Product rich results for variable products with price range display (e.g., "$10.00 - $25.00")
Output: Product_Schema class extended to handle variable products with AggregateOffer schema
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-variable-products/09-RESEARCH.md

# Existing implementation to extend
@includes/Schema/Types/class-product-schema.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add build_aggregate_offer method</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Add a new protected method `build_aggregate_offer()` after the existing `build_offer()` method.

Method signature: `protected function build_aggregate_offer( \WC_Product_Variable $product ): array`

Implementation:
1. Get min/max prices using `$product->get_variation_price('min')` and `$product->get_variation_price('max')`
2. Validate both prices are non-empty and greater than zero - return empty array if either fails
3. Build AggregateOffer array with:
   - `@type` = 'AggregateOffer'
   - `lowPrice` = min price
   - `highPrice` = max price
   - `priceCurrency` = `get_woocommerce_currency()`
   - `url` = `$this->context->canonical`
4. Add availability using `child_is_in_stock()`:
   - If true: 'https://schema.org/InStock'
   - If false: 'https://schema.org/OutOfStock'
5. Add optional `offerCount` = count of `$product->get_children()`
6. Return the aggregate array

Do NOT include priceValidUntil (variations may have different sale dates).
Do NOT include seller (not standard for AggregateOffer).
  </action>
  <verify>Method exists in class with proper PHPDoc. Code review confirms all properties included.</verify>
  <done>build_aggregate_offer() method returns valid AggregateOffer array for variable products.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate AggregateOffer into generate method</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
In the `generate()` method, find the existing simple product offers block (around line 85):

```php
if ( $product->is_type( 'simple' ) ) {
    $offer = $this->build_offer( $product );
    if ( ! empty( $offer ) ) {
        $schema['offers'] = $offer;
    }
}
```

Add an `elseif` branch for variable products immediately after:

```php
} elseif ( $product->is_type( 'variable' ) ) {
    $aggregate_offer = $this->build_aggregate_offer( $product );
    if ( ! empty( $aggregate_offer ) ) {
        $schema['offers'] = $aggregate_offer;
    }
}
```

The type check with `is_type('variable')` is safe - WooCommerce ensures the method is available.
  </action>
  <verify>grep for "is_type.*variable" shows the new branch exists in generate().</verify>
  <done>Variable products now output AggregateOffer schema instead of being skipped.</done>
</task>

<task type="auto">
  <name>Task 3: Verify implementation and commit</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Run full verification:
1. Check file for syntax errors: `php -l includes/Schema/Types/class-product-schema.php`
2. Verify build_aggregate_offer method exists with correct signature
3. Verify generate() handles both simple and variable product types
4. Review code matches research patterns from 09-RESEARCH.md

Create atomic commit with message:
```
feat(09-01): implement AggregateOffer for variable products

- Add build_aggregate_offer() with lowPrice/highPrice from variation prices
- Availability uses child_is_in_stock() for any-variation-in-stock logic
- Integrate into generate() with elseif branch for variable products
- Include optional offerCount for variation count

Closes OFFR-04, OFFR-05
```
  </action>
  <verify>PHP syntax check passes. Commit created successfully.</verify>
  <done>Implementation complete, verified, and committed.</done>
</task>

</tasks>

<verification>
1. PHP lint passes: `php -l includes/Schema/Types/class-product-schema.php`
2. Method exists: `grep -n "build_aggregate_offer" includes/Schema/Types/class-product-schema.php`
3. Variable branch exists: `grep -n "is_type.*variable" includes/Schema/Types/class-product-schema.php`
4. AggregateOffer type present: `grep "AggregateOffer" includes/Schema/Types/class-product-schema.php`
</verification>

<success_criteria>
1. Variable products output AggregateOffer with lowPrice/highPrice from variation price range
2. AggregateOffer includes priceCurrency from store settings
3. AggregateOffer availability shows InStock if ANY variation is in stock (child_is_in_stock)
4. Simple products continue to output single Offer (no regression)
5. Products with invalid prices (zero/empty) return no offers (maintains Phase 8 behavior)
</success_criteria>

<output>
After completion, create `.planning/phases/09-variable-products/09-01-SUMMARY.md`
</output>
