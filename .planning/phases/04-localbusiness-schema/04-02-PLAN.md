---
phase: 04-localbusiness-schema
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - includes/class-saman-seo-plugin.php
  - includes/class-saman-seo-service-local-seo.php
autonomous: true

must_haves:
  truths:
    - "LocalBusiness schema appears in @graph on homepage when settings configured"
    - "Legacy add_local_business_to_graph filter no longer outputs duplicate LocalBusiness"
    - "LocalBusiness has priority 5 (after Organization at 2, before WebPage at 10)"
    - "Schema output contains no duplicate @context entries"
  artifacts:
    - path: "includes/class-saman-seo-plugin.php"
      provides: "LocalBusiness_Schema registration"
      contains: "register.*localbusiness.*LocalBusiness_Schema"
    - path: "includes/class-saman-seo-service-local-seo.php"
      provides: "Legacy filter disabled"
      contains: "Removed:.*add_local_business_to_graph"
  key_links:
    - from: "includes/class-saman-seo-plugin.php"
      to: "LocalBusiness_Schema::class"
      via: "registry->register() call"
      pattern: "registry->register.*localbusiness"
    - from: "Schema_Registry"
      to: "LocalBusiness_Schema"
      via: "registration with priority 5"
      pattern: "priority.*5"
---

<objective>
Wire LocalBusiness_Schema into the schema registry and disable the legacy filter that incorrectly outputs LocalBusiness with @context.

Purpose: Complete the LocalBusiness schema integration by ensuring it outputs through the new registry system (with proper @graph structure) and removing the legacy duplicate output that includes incorrect @context.

Output: LocalBusiness schema appears in registry output, legacy filter disabled
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-localbusiness-schema/04-RESEARCH.md
@.planning/phases/04-localbusiness-schema/04-01-SUMMARY.md

# Files to modify
@includes/class-saman-seo-plugin.php
@includes/class-saman-seo-service-local-seo.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register LocalBusiness_Schema in plugin bootstrap</name>
  <files>includes/class-saman-seo-plugin.php</files>
  <action>
Add LocalBusiness_Schema registration to the plugin's `boot()` method.

1. **Add use statement** at top of file with other Schema\Types imports:
   ```php
   use Saman\SEO\Schema\Types\LocalBusiness_Schema;
   ```

2. **Register with priority 5** - Add after Organization/Person (priority 2) and before WebPage (priority 10):

   Find the section where Organization and Person are registered (around line 69-70):
   ```php
   $registry->register( 'organization', Organization_Schema::class, [ 'priority' => 2 ] );
   $registry->register( 'person', Person_Schema::class, [ 'priority' => 2 ] );
   ```

   Add LocalBusiness registration immediately after:
   ```php
   // LocalBusiness schema (priority 5 - after Organization 2, before WebPage 10).
   $registry->register(
       'localbusiness',
       LocalBusiness_Schema::class,
       [
           'label'    => __( 'Local Business', 'saman-seo' ),
           'priority' => 5,
       ]
   );
   ```

Priority 5 ensures LocalBusiness appears:
- After WebSite (1), Organization (2), Person (2)
- Before WebPage (10), Content (15), Interactive (18), Breadcrumb (20)

This matches the Schema.org hierarchy where LocalBusiness is a subtype of Organization.
  </action>
  <verify>
1. Use statement exists:
```bash
grep "use.*LocalBusiness_Schema" includes/class-saman-seo-plugin.php
```

2. Registration exists with priority 5:
```bash
grep -A5 "register.*localbusiness" includes/class-saman-seo-plugin.php
```
  </verify>
  <done>LocalBusiness_Schema registered in plugin with priority 5, appears in registry between Organization and WebPage</done>
</task>

<task type="auto">
  <name>Task 2: Disable legacy add_local_business_to_graph filter</name>
  <files>includes/class-saman-seo-service-local-seo.php</files>
  <action>
Disable the legacy filter that outputs LocalBusiness with incorrect @context.

In `Local_SEO::boot()` method, find and comment out the filter line:

Current code (around line 31):
```php
add_filter( 'SAMAN_SEO_jsonld_graph', [ $this, 'add_local_business_to_graph' ], 20, 1 );
```

Change to:
```php
// Removed: LocalBusiness schema now handled by Schema Registry (LocalBusiness_Schema class).
// Legacy filter disabled to prevent duplicate output with incorrect @context.
// add_filter( 'SAMAN_SEO_jsonld_graph', [ $this, 'add_local_business_to_graph' ], 20, 1 );
```

IMPORTANT: Keep the method `add_local_business_to_graph()` intact - just remove the hook. This preserves backward compatibility in case any third-party code calls the method directly (though unlikely).

DO NOT delete the method because:
1. It may be called by external code
2. The multi-location logic exists there (deferred to future phase)
3. Keeping it documents the legacy implementation
  </action>
  <verify>
1. Filter line is commented out:
```bash
grep -n "add_local_business_to_graph" includes/class-saman-seo-service-local-seo.php | head -3
```

Should show the commented filter line but NOT an active add_filter call.

2. Method still exists (for backward compatibility):
```bash
grep "function add_local_business_to_graph" includes/class-saman-seo-service-local-seo.php
```
  </verify>
  <done>Legacy SAMAN_SEO_jsonld_graph filter disabled, method preserved for backward compatibility, comment explains migration to Schema Registry</done>
</task>

<task type="auto">
  <name>Task 3: Verify complete integration</name>
  <files></files>
  <action>
Verify the complete LocalBusiness schema integration works correctly.

Run these checks:

1. **PHP syntax check on modified files:**
```bash
php -l includes/class-saman-seo-plugin.php
php -l includes/class-saman-seo-service-local-seo.php
php -l includes/Schema/Types/class-localbusiness-schema.php
```

2. **Verify registration order in plugin:**
```bash
grep -n "registry->register" includes/class-saman-seo-plugin.php
```

Expected order by priority:
- website (1)
- organization (2)
- person (2)
- localbusiness (5) <-- NEW
- webpage (10)
- article (15)
- blogposting (15)
- newsarticle (15)
- faqpage (18)
- howto (18)
- breadcrumb (20)

3. **Verify LocalBusiness_Schema class loads without errors:**
```bash
php -r "
require_once 'saman-seo.php';
use Saman\SEO\Schema\Types\LocalBusiness_Schema;
echo class_exists(LocalBusiness_Schema::class) ? 'Class exists' : 'Class missing';
"
```

If the above fails due to WordPress dependencies, that's expected. The PHP lint check is sufficient.
  </action>
  <verify>
All PHP files pass syntax check (no parse errors).
Registration appears in correct priority order.
  </verify>
  <done>All files pass PHP lint, LocalBusiness_Schema properly integrated into registry with correct priority ordering</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. LocalBusiness_Schema is registered in plugin with priority 5
2. Legacy filter is disabled (commented out with explanation)
3. All PHP files pass syntax validation
4. Priority ordering maintains: WebSite(1) -> Organization(2) -> LocalBusiness(5) -> WebPage(10) -> Content(15) -> Interactive(18) -> Breadcrumb(20)
5. No active add_filter for add_local_business_to_graph exists

Manual verification (if WordPress environment available):
- Visit homepage with Local SEO settings configured
- View page source, find JSON-LD script
- LocalBusiness should appear in @graph (NOT as separate script with own @context)
</verification>

<success_criteria>
- LocalBusiness_Schema registered in class-saman-seo-plugin.php with priority 5
- Use statement for LocalBusiness_Schema added
- add_filter for add_local_business_to_graph commented out in Local_SEO::boot()
- Comment explains migration to Schema Registry
- All PHP files pass lint check
- Registration appears between Organization (2) and WebPage (10) in file order
</success_criteria>

<output>
After completion, create `.planning/phases/04-localbusiness-schema/04-02-SUMMARY.md`
</output>
