---
phase: 04-localbusiness-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Schema/class-schema-ids.php
  - includes/Schema/Types/class-localbusiness-schema.php
autonomous: true

must_haves:
  truths:
    - "LocalBusiness_Schema class exists and follows Abstract_Schema contract"
    - "Schema_IDs::localbusiness() returns valid URL#localbusiness identifier"
    - "LocalBusiness_Schema reads from existing SAMAN_SEO_local_* options"
    - "Schema output includes @type matching SAMAN_SEO_local_business_type option"
  artifacts:
    - path: "includes/Schema/Types/class-localbusiness-schema.php"
      provides: "LocalBusiness schema class with full property support"
      contains: "class LocalBusiness_Schema extends Abstract_Schema"
    - path: "includes/Schema/class-schema-ids.php"
      provides: "localbusiness() method for @id generation"
      contains: "public static function localbusiness()"
  key_links:
    - from: "includes/Schema/Types/class-localbusiness-schema.php"
      to: "Schema_IDs::localbusiness()"
      via: "get_id() method call"
      pattern: "Schema_IDs::localbusiness\\(\\)"
    - from: "includes/Schema/Types/class-localbusiness-schema.php"
      to: "SAMAN_SEO_local_* options"
      via: "get_option() calls"
      pattern: "get_option\\(.*SAMAN_SEO_local"
---

<objective>
Create LocalBusiness_Schema class that generates LocalBusiness schema output by reading from existing Local SEO settings.

Purpose: Enable rich results for local businesses by outputting valid LocalBusiness structured data that pulls from already-configured Local SEO settings, avoiding duplicate data entry.

Output: LocalBusiness_Schema class + Schema_IDs::localbusiness() method
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-localbusiness-schema/04-RESEARCH.md

# Existing patterns
@includes/Schema/class-abstract-schema.php
@includes/Schema/class-schema-ids.php
@includes/Schema/Types/class-organization-schema.php

# Existing Local SEO service (for option names reference)
@includes/class-saman-seo-service-local-seo.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Schema_IDs::localbusiness() method</name>
  <files>includes/Schema/class-schema-ids.php</files>
  <action>
Add a new static method `localbusiness()` to the Schema_IDs class following the existing pattern.

The method should:
- Return `home_url( '/' ) . '#localbusiness'`
- Include proper PHPDoc with `@return string` annotation
- Follow the exact style of existing methods (website(), organization(), etc.)

Insert after the existing `howto()` method (last in the class) to maintain alphabetical-by-addition order.

```php
/**
 * Get the LocalBusiness schema @id.
 *
 * @return string URL#localbusiness identifier.
 */
public static function localbusiness(): string {
    return home_url( '/' ) . '#localbusiness';
}
```

NOTE: LocalBusiness uses site root URL (like Organization) NOT a page-specific URL (unlike Article, Breadcrumb) because it represents the business entity, not a page.
  </action>
  <verify>
Method exists in class-schema-ids.php and follows existing pattern. Verify with grep:
```bash
grep -A4 "function localbusiness" includes/Schema/class-schema-ids.php
```
  </verify>
  <done>Schema_IDs::localbusiness() returns home_url('/').'#localbusiness'</done>
</task>

<task type="auto">
  <name>Task 2: Create LocalBusiness_Schema class</name>
  <files>includes/Schema/Types/class-localbusiness-schema.php</files>
  <action>
Create `class-localbusiness-schema.php` in `includes/Schema/Types/` following the Abstract_Schema pattern.

The class must:

1. **Namespace and imports:**
   ```php
   namespace Saman\SEO\Schema\Types;

   use Saman\SEO\Schema\Abstract_Schema;
   use Saman\SEO\Schema\Schema_IDs;
   ```

2. **get_type() method:**
   - Return `get_option( 'SAMAN_SEO_local_business_type', 'LocalBusiness' )`
   - This respects user's business type selection (Restaurant, Dentist, etc.)

3. **is_needed() method:**
   - Return `true` only if `is_front_page() || is_home()` AND business name is not empty
   - LocalBusiness schema should only appear on homepage (like Organization)

4. **generate() method builds schema with these properties:**
   - `@type` from get_type()
   - `@id` from Schema_IDs::localbusiness()
   - `name` from SAMAN_SEO_local_business_name
   - `url` from home_url('/')

   Then call private helper methods for optional properties:
   - `add_logo()` - ImageObject from SAMAN_SEO_local_logo
   - `add_image()` - SAMAN_SEO_local_image
   - `add_description()` - SAMAN_SEO_local_description
   - `add_contact()` - telephone + email
   - `add_price_range()` - SAMAN_SEO_local_price_range
   - `add_address()` - PostalAddress nested type
   - `add_geo()` - GeoCoordinates nested type
   - `add_opening_hours()` - OpeningHoursSpecification array
   - `add_social_profiles()` - sameAs array

5. **Private helper methods (pass schema by reference):**

   **add_logo(&$schema):**
   - Read SAMAN_SEO_local_logo
   - If not empty, add `logo` as ImageObject with @type and url

   **add_image(&$schema):**
   - Read SAMAN_SEO_local_image
   - If not empty, add `image` property

   **add_description(&$schema):**
   - Read SAMAN_SEO_local_description
   - If not empty, add `description` property

   **add_contact(&$schema):**
   - Read SAMAN_SEO_local_phone and SAMAN_SEO_local_email
   - Add `telephone` if phone not empty
   - Add `email` if email not empty

   **add_price_range(&$schema):**
   - Read SAMAN_SEO_local_price_range
   - If not empty, add `priceRange` property

   **add_address(&$schema):**
   - Read street, city, state, zip, country from SAMAN_SEO_local_* options
   - Require at least street AND city (return early if missing)
   - Build PostalAddress nested type with:
     - @type: PostalAddress
     - streetAddress, addressLocality (required)
     - addressRegion, postalCode, addressCountry (optional)

   **add_geo(&$schema):**
   - Read SAMAN_SEO_local_latitude and SAMAN_SEO_local_longitude
   - Require both (return early if either empty)
   - Build GeoCoordinates with:
     - @type: GeoCoordinates
     - latitude: (float) cast
     - longitude: (float) cast

   **add_opening_hours(&$schema):**
   - Read SAMAN_SEO_local_opening_hours (array)
   - Return early if empty or not array
   - Day map: monday->Monday, tuesday->Tuesday, etc.
   - Group days with same hours (open-close key)
   - Build OpeningHoursSpecification array:
     - @type: OpeningHoursSpecification
     - dayOfWeek: single string or array (if multiple days have same hours)
     - opens: HH:MM format
     - closes: HH:MM format
   - Add openingHoursSpecification property if not empty

   **add_social_profiles(&$schema):**
   - Read SAMAN_SEO_local_social_profiles
   - If array and not empty, filter and add as `sameAs`

IMPORTANT: Do NOT include @context anywhere - Graph_Manager handles that at root level.

Follow the complete implementation from 04-RESEARCH.md Code Examples section.
  </action>
  <verify>
1. File exists with correct class structure:
```bash
grep -c "class LocalBusiness_Schema extends Abstract_Schema" includes/Schema/Types/class-localbusiness-schema.php
```

2. All three abstract methods implemented:
```bash
grep -E "function (get_type|is_needed|generate)" includes/Schema/Types/class-localbusiness-schema.php
```

3. No @context in output (anti-pattern):
```bash
grep "@context" includes/Schema/Types/class-localbusiness-schema.php || echo "Good: no @context"
```

4. Uses Schema_IDs::localbusiness():
```bash
grep "Schema_IDs::localbusiness()" includes/Schema/Types/class-localbusiness-schema.php
```
  </verify>
  <done>LocalBusiness_Schema class exists with full property support, reads from SAMAN_SEO_local_* options, includes nested PostalAddress, GeoCoordinates, and OpeningHoursSpecification types</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Schema_IDs has localbusiness() method
2. LocalBusiness_Schema follows Abstract_Schema contract
3. Class reads from existing SAMAN_SEO_local_* options
4. Nested types (PostalAddress, GeoCoordinates, OpeningHoursSpecification) are properly structured
5. No @context in schema output
6. Business type from settings is honored
</verification>

<success_criteria>
- includes/Schema/class-schema-ids.php contains localbusiness() static method
- includes/Schema/Types/class-localbusiness-schema.php exists
- LocalBusiness_Schema implements get_type(), is_needed(), generate()
- generate() returns array with @type, @id, name, url and conditional properties
- No @context anywhere in LocalBusiness_Schema
- All helper methods are private and pass schema by reference
</success_criteria>

<output>
After completion, create `.planning/phases/04-localbusiness-schema/04-01-SUMMARY.md`
</output>
