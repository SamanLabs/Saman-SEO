---
phase: 08-simple-products
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - includes/Schema/Types/class-product-schema.php
autonomous: true

must_haves:
  truths:
    - "Simple products output single Offer with price and priceCurrency"
    - "Offer outputs availability URL based on WooCommerce stock status"
    - "Offer outputs priceValidUntil when product has sale end date"
    - "Offer outputs seller referencing Organization schema"
    - "Products with zero or empty price do NOT output offers"
  artifacts:
    - path: "includes/Schema/Types/class-product-schema.php"
      provides: "Complete simple product schema with Offer"
      contains: "build_offer"
      min_lines: 200
  key_links:
    - from: "Product_Schema::generate()"
      to: "build_offer()"
      via: "conditional call for simple products"
      pattern: "is_type.*simple.*build_offer"
    - from: "build_offer()"
      to: "get_availability_url()"
      via: "availability mapping"
      pattern: "get_availability_url.*\\$product"
    - from: "build_offer()"
      to: "Schema_IDs::organization()"
      via: "seller reference"
      pattern: "seller.*Schema_IDs::organization"
---

<objective>
Implement Offer schema for simple products with price, availability, and seller.

Purpose: Complete the Product schema with Offer data required for Google Merchant Listings and Product rich results.

Output: Simple products output complete Product + Offer schema that passes Google Rich Results Test.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-simple-products/08-RESEARCH.md
@.planning/phases/08-simple-products/08-01-SUMMARY.md

@includes/Schema/Types/class-product-schema.php (after Plan 01)
@includes/Schema/class-schema-ids.php (for Organization @id)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement availability URL mapping</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Add helper method to map WooCommerce stock status to schema.org availability URLs:

```php
/**
 * Get schema.org availability URL from WooCommerce stock status.
 *
 * @param \WC_Product $product The product object.
 * @return string Schema.org availability URL.
 */
protected function get_availability_url( \WC_Product $product ): string {
    $status = $product->get_stock_status();

    $map = [
        'instock'     => 'https://schema.org/InStock',
        'outofstock'  => 'https://schema.org/OutOfStock',
        'onbackorder' => 'https://schema.org/PreOrder',
    ];

    return $map[ $status ] ?? 'https://schema.org/InStock';
}
```

Key points:
- Use `$product->get_stock_status()` NOT direct meta access
- Use HTTPS schema.org URLs (not HTTP)
- Default to InStock if unknown status (safe fallback)
- onbackorder maps to PreOrder (Google-recommended mapping)
  </action>
  <verify>
Run: `grep -A 10 "get_availability_url" includes/Schema/Types/class-product-schema.php`
Confirm all three mappings use https://schema.org/ prefix.
  </verify>
  <done>
Availability URL mapping works for instock, outofstock, and onbackorder statuses (OFFR-02).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Offer building for simple products</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Add build_offer() method and integrate with generate():

```php
/**
 * Build Offer schema for simple products.
 *
 * @param \WC_Product $product The product object.
 * @return array Offer schema array, empty if price is invalid.
 */
protected function build_offer( \WC_Product $product ): array {
    $price = $product->get_price();

    // Price is required for merchant listings - skip if zero/empty.
    if ( empty( $price ) || (float) $price <= 0 ) {
        return [];
    }

    $offer = [
        '@type'         => 'Offer',
        'price'         => $price,
        'priceCurrency' => get_woocommerce_currency(),
        'availability'  => $this->get_availability_url( $product ),
        'url'           => $this->context->canonical,
    ];

    // priceValidUntil from sale end date (OFFR-03).
    $sale_end = $product->get_date_on_sale_to();
    if ( $sale_end instanceof \WC_DateTime ) {
        $offer['priceValidUntil'] = $sale_end->format( 'Y-m-d' );
    }

    // Seller reference to Organization (OFFR-06).
    // Only add when Organization type is active (most stores).
    if ( get_option( 'SAMAN_SEO_homepage_knowledge_type', 'organization' ) === 'organization' ) {
        $offer['seller'] = [ '@id' => Schema_IDs::organization() ];
    }

    return $offer;
}
```

Update generate() to add offers for simple products ONLY:
```php
// Offers (only for simple products in this phase).
if ( $product->is_type( 'simple' ) ) {
    $offer = $this->build_offer( $product );
    if ( ! empty( $offer ) ) {
        $schema['offers'] = $offer;
    }
}
```

Key decisions:
- Use `$product->get_price()` for active price (handles sale price automatically)
- Use `get_woocommerce_currency()` for proper ISO 4217 currency code
- Check `$product->is_type( 'simple' )` to exclude variable products (Phase 9)
- Skip offers entirely if price is empty or zero
- priceValidUntil uses Y-m-d format (ISO 8601 date only, no time)
- Seller only added when Organization type is selected in settings
  </action>
  <verify>
Read the updated file and confirm:
1. build_offer() returns empty array for price <= 0
2. build_offer() uses get_woocommerce_currency()
3. generate() checks is_type('simple') before adding offers
4. seller uses Schema_IDs::organization() reference
  </verify>
  <done>
Simple products output complete Offer with price (OFFR-01), priceCurrency (OFFR-01), availability (OFFR-02), priceValidUntil (OFFR-03), and seller (OFFR-06).
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and code review</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Review the complete Product_Schema class for:

1. **Method order** - Ensure methods are in logical order:
   - get_type(), is_needed(), generate() (inherited interface)
   - get_id() (override)
   - add_* helpers (description, images, sku, brand, identifiers, condition)
   - get_brand(), get_images(), get_availability_url() (data fetchers)
   - build_offer() (Offer construction)

2. **PHPDoc comments** - Ensure all methods have proper docblocks with:
   - Description
   - @param types
   - @return type

3. **Import check** - Verify Schema_IDs is imported (should already be from skeleton):
   ```php
   use Saman\SEO\Schema\Schema_IDs;
   ```

4. **Filter application** - Ensure apply_fields_filter() is called at end of generate() (should already exist from skeleton).

5. **Edge cases** - Verify all conditionals check for empty/falsy values before adding to schema.

If any issues found, fix them. If all looks good, the plan is complete.
  </action>
  <verify>
Run: `php -l includes/Schema/Types/class-product-schema.php`
Confirm no syntax errors.

Count methods: `grep -c "function " includes/Schema/Types/class-product-schema.php`
Should be 10+ functions (generate, is_needed, get_type, get_id, add_*, get_*, build_offer).
  </verify>
  <done>
Product_Schema is complete, well-documented, and syntactically valid. Ready for Phase 9 (variable products).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. PHP lint passes: `php -l includes/Schema/Types/class-product-schema.php`
2. Class has 10+ methods covering all requirements
3. No HTML in description (wp_strip_all_tags used)
4. No empty properties output (all conditionals check for empty)
5. Availability uses https://schema.org/ URLs
6. Seller references Organization via Schema_IDs

Expected output structure for simple product:
```json
{
  "@type": "Product",
  "@id": "https://example.com/product/widget/#product",
  "name": "Widget",
  "url": "https://example.com/product/widget/",
  "description": "A wonderful widget",
  "image": ["https://example.com/wp-content/uploads/widget.jpg"],
  "sku": "WIDGET-001",
  "brand": {"@type": "Brand", "name": "Acme"},
  "gtin": "123456789012",
  "itemCondition": "https://schema.org/NewCondition",
  "offers": {
    "@type": "Offer",
    "price": "29.99",
    "priceCurrency": "USD",
    "availability": "https://schema.org/InStock",
    "url": "https://example.com/product/widget/",
    "seller": {"@id": "https://example.com/#organization"}
  }
}
```
</verification>

<success_criteria>
- [ ] OFFR-01: Simple products output Offer with price and priceCurrency
- [ ] OFFR-02: Offer availability maps InStock/OutOfStock/PreOrder correctly
- [ ] OFFR-03: priceValidUntil outputs from sale end date when present
- [ ] OFFR-06: seller references Organization @id
- [ ] Products with price=0 or empty price do NOT output offers
- [ ] Variable products do NOT output offers (is_type check)
- [ ] PHP syntax valid
- [ ] All methods have PHPDoc comments
</success_criteria>

<output>
After completion, create `.planning/phases/08-simple-products/08-02-SUMMARY.md`
</output>
