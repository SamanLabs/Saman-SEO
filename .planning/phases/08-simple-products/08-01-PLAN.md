---
phase: 08-simple-products
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Schema/Types/class-product-schema.php
autonomous: true

must_haves:
  truths:
    - "Product schema outputs name from product title"
    - "Product schema outputs description from short description (HTML stripped)"
    - "Product schema outputs image array with featured + gallery images"
    - "Product schema outputs sku when product has SKU"
    - "Product schema outputs brand from meta field, product attribute, or global setting"
    - "Product schema outputs gtin/mpn from custom fields when populated"
    - "Product schema outputs itemCondition with full URL format"
  artifacts:
    - path: "includes/Schema/Types/class-product-schema.php"
      provides: "Product core properties"
      contains: "add_description"
      min_lines: 150
  key_links:
    - from: "Product_Schema::generate()"
      to: "helper methods"
      via: "method calls in generate()"
      pattern: "\\$this->add_(description|images|sku|brand|identifiers|condition)"
    - from: "add_brand()"
      to: "get_brand()"
      via: "fallback chain method"
      pattern: "get_brand.*\\$product"
---

<objective>
Implement Product schema core properties for simple products.

Purpose: Enable Google Product rich results by outputting the required and recommended Product properties (name, description, image, sku, brand, gtin, mpn, itemCondition).

Output: Fully populated Product schema with all PROD-* requirements satisfied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-simple-products/08-RESEARCH.md

@includes/Schema/Types/class-product-schema.php (current skeleton)
@includes/Schema/Types/class-article-schema.php (pattern reference for helper methods)
@includes/Schema/class-abstract-schema.php (base class)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add description, images, and sku properties</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Extend the Product_Schema::generate() method with helper method calls and implement three helper methods:

1. **add_description()** - Get short description via `$product->get_short_description()`, strip HTML with `wp_strip_all_tags()`, add to schema['description'] if not empty.

2. **get_images()** - Build image array with featured image first (`$product->get_image_id()` + `wp_get_attachment_image_url()`), then gallery images (`$product->get_gallery_image_ids()`). Return array of URLs. Only use 'full' size.

3. **add_sku()** - Get SKU via `$product->get_sku()`, add to schema['sku'] if not empty.

Update generate() to call these helpers after the initial $schema array is built:
```php
$this->add_description( $schema, $product );
$this->add_images( $schema, $product );
$this->add_sku( $schema, $product );
```

Follow Article_Schema pattern: helpers take &$schema by reference and $product as parameters.

Pitfall to avoid: Do NOT output empty arrays for images. Check `! empty( $images )` before adding.
  </action>
  <verify>
Read the updated file and confirm:
1. add_description() strips HTML tags
2. get_images() returns array of URLs starting with featured image
3. add_sku() checks for empty before adding
4. generate() calls all three helpers
  </verify>
  <done>
Product schema outputs description (PROD-02), image array (PROD-03), and sku (PROD-04) when data exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add brand with fallback chain and identifiers</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Implement brand fallback chain and identifiers (GTIN/MPN):

1. **get_brand()** - Three-level fallback:
   - First: `get_post_meta( $product->get_id(), '_SAMAN_SEO_brand', true )`
   - Second: `$product->get_attribute( 'brand' )`
   - Third: `get_option( 'SAMAN_SEO_product_default_brand', '' )`
   Return first non-empty value.

2. **add_brand()** - Call get_brand(), if not empty add to schema:
   ```php
   $schema['brand'] = [
       '@type' => 'Brand',
       'name'  => $brand,
   ];
   ```

3. **add_identifiers()** - Get GTIN and MPN from post meta:
   - GTIN: `get_post_meta( $product->get_id(), '_SAMAN_SEO_gtin', true )` -> schema['gtin']
   - MPN: `get_post_meta( $product->get_id(), '_SAMAN_SEO_mpn', true )` -> schema['mpn']
   Add each only if not empty.

Update generate() to call:
```php
$this->add_brand( $schema, $product );
$this->add_identifiers( $schema, $product );
```
  </action>
  <verify>
Read the updated file and confirm:
1. get_brand() implements 3-level fallback chain
2. add_brand() outputs Brand @type object structure
3. add_identifiers() checks for empty before adding gtin/mpn
  </verify>
  <done>
Product schema outputs brand (PROD-06) with fallback chain and gtin/mpn (PROD-07) from custom fields.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add itemCondition with URL format</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Implement itemCondition with full URL format (PROD-08):

1. **add_condition()** - Get condition from meta or default to NewCondition:
   ```php
   protected function add_condition( array &$schema, \WC_Product $product ): void {
       $condition = get_post_meta( $product->get_id(), '_SAMAN_SEO_condition', true );

       // Default to NewCondition
       if ( empty( $condition ) ) {
           $condition = 'NewCondition';
       }

       // Valid conditions per schema.org
       $valid = [
           'NewCondition',
           'UsedCondition',
           'RefurbishedCondition',
           'DamagedCondition',
       ];

       if ( in_array( $condition, $valid, true ) ) {
           $schema['itemCondition'] = 'https://schema.org/' . $condition;
       }
   }
   ```

2. Update generate() to call `$this->add_condition( $schema, $product );`

CRITICAL: Use full URL format `https://schema.org/NewCondition` NOT just `NewCondition`. Google requires the full URL for itemCondition values.
  </action>
  <verify>
Run: `grep -n "https://schema.org/" includes/Schema/Types/class-product-schema.php`
Confirm itemCondition uses https://schema.org/ prefix.
  </verify>
  <done>
Product schema outputs itemCondition (PROD-08) with full schema.org URL format. Defaults to NewCondition.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify generate() method calls all helpers in correct order
2. Verify each helper method follows the conditional pattern (check before adding)
3. Verify Brand is output as object with @type and name
4. Verify itemCondition uses https://schema.org/ URL format
5. Run: `grep -c "protected function" includes/Schema/Types/class-product-schema.php` - should show 7+ methods (existing + new helpers)
</verification>

<success_criteria>
- [ ] PROD-01: name property outputs from get_name() (already exists)
- [ ] PROD-02: description outputs from short_description, HTML stripped
- [ ] PROD-03: image outputs as array with featured + gallery images
- [ ] PROD-04: sku outputs when product has SKU
- [ ] PROD-05: url outputs from canonical (already exists)
- [ ] PROD-06: brand outputs with 3-level fallback chain
- [ ] PROD-07: gtin/mpn outputs from custom fields
- [ ] PROD-08: itemCondition outputs with full URL format, defaults to NewCondition
</success_criteria>

<output>
After completion, create `.planning/phases/08-simple-products/08-01-SUMMARY.md`
</output>
