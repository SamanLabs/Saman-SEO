---
phase: 10-reviews-ratings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Schema/Types/class-product-schema.php
autonomous: true

must_haves:
  truths:
    - "Products with reviews output AggregateRating with ratingValue and reviewCount"
    - "Products with zero reviews do NOT output AggregateRating"
    - "Product schema outputs Review array with individual customer reviews"
    - "Each Review includes author Person, reviewRating, reviewBody, datePublished"
  artifacts:
    - path: "includes/Schema/Types/class-product-schema.php"
      provides: "AggregateRating and Review schema generation"
      contains: "add_aggregate_rating"
      exports: ["add_aggregate_rating", "add_reviews", "build_review"]
  key_links:
    - from: "includes/Schema/Types/class-product-schema.php"
      to: "WC_Product::get_average_rating()"
      via: "WooCommerce review API"
      pattern: "get_average_rating"
    - from: "includes/Schema/Types/class-product-schema.php"
      to: "get_comments()"
      via: "WordPress comments API with type='review'"
      pattern: "get_comments"
---

<objective>
Implement AggregateRating and Review schema for WooCommerce product reviews, completing the Product rich results implementation for v1.1.

Purpose: Enable Google review star ratings in search results for products with customer reviews
Output: Product_Schema class extended with aggregateRating and review properties from WooCommerce reviews
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-reviews-ratings/10-RESEARCH.md

# Existing implementation to extend
@includes/Schema/Types/class-product-schema.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AggregateRating method</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Add a new protected method `add_aggregate_rating()` after the existing `add_condition()` method.

Method signature: `protected function add_aggregate_rating( array &$schema, \WC_Product $product ): void`

Implementation:
1. Get review count: `$review_count = $product->get_review_count();`
2. CRITICAL: Return early if review_count < 1 (REVW-04 - products with zero reviews must NOT output AggregateRating)
3. Get average rating: `$average_rating = $product->get_average_rating();`
4. Return early if average_rating is empty or <= 0 (invalid rating)
5. Add aggregateRating to schema:
```php
$schema['aggregateRating'] = [
    '@type'       => 'AggregateRating',
    'ratingValue' => round( (float) $average_rating, 1 ),
    'reviewCount' => (int) $review_count,
    'bestRating'  => 5,
    'worstRating' => 1,
];
```

Do NOT use ratingCount (reviewCount is preferred by Google when actual reviews exist).
  </action>
  <verify>Run: `grep -n "add_aggregate_rating" includes/Schema/Types/class-product-schema.php` confirms method exists. Run: `grep "AggregateRating\|ratingValue\|reviewCount" includes/Schema/Types/class-product-schema.php` confirms properties.</verify>
  <done>add_aggregate_rating() method adds AggregateRating only when product has reviews.</done>
</task>

<task type="auto">
  <name>Task 2: Add Reviews methods</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
Add two new protected methods after add_aggregate_rating():

**Method 1: add_reviews()**
Signature: `protected function add_reviews( array &$schema, \WC_Product $product ): void`

Implementation:
1. Return early if `$product->get_review_count() < 1`
2. Query reviews using WordPress comments API:
```php
$comments = get_comments( [
    'post_id' => $product->get_id(),
    'status'  => 'approve',
    'type'    => 'review',
    'number'  => 10,
    'orderby' => 'comment_date_gmt',
    'order'   => 'DESC',
] );
```
3. Return early if `empty( $comments )`
4. Build reviews array:
```php
$reviews = [];
foreach ( $comments as $comment ) {
    $review = $this->build_review( $comment );
    if ( ! empty( $review ) ) {
        $reviews[] = $review;
    }
}
```
5. Add to schema if reviews exist: `$schema['review'] = $reviews;`

**Method 2: build_review()**
Signature: `protected function build_review( \WP_Comment $comment ): array`

Implementation:
1. Get author name: `$author_name = trim( $comment->comment_author );`
2. Return empty array if author_name is empty (Google requires author)
3. Get rating from comment meta: `$rating = (int) get_comment_meta( $comment->comment_ID, 'rating', true );`
4. Return empty array if rating < 1 or rating > 5 (invalid rating)
5. Build Review schema:
```php
$review = [
    '@type'        => 'Review',
    'author'       => [
        '@type' => 'Person',
        'name'  => $author_name,
    ],
    'reviewRating' => [
        '@type'       => 'Rating',
        'ratingValue' => $rating,
        'bestRating'  => 5,
        'worstRating' => 1,
    ],
    'datePublished' => gmdate( 'Y-m-d', strtotime( $comment->comment_date_gmt ) ),
];
```
6. Optionally add reviewBody if comment_content not empty:
```php
$review_body = trim( $comment->comment_content );
if ( ! empty( $review_body ) ) {
    $review['reviewBody'] = wp_strip_all_tags( $review_body );
}
```
7. Return the review array.

Limit to 10 reviews for performance (configurable via filter in future if needed).
  </action>
  <verify>Run: `grep -n "add_reviews\|build_review" includes/Schema/Types/class-product-schema.php` confirms both methods exist. Run: `grep "get_comments\|reviewRating\|datePublished" includes/Schema/Types/class-product-schema.php` confirms implementation.</verify>
  <done>add_reviews() retrieves WooCommerce reviews and build_review() converts each to schema format.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into generate() and verify</name>
  <files>includes/Schema/Types/class-product-schema.php</files>
  <action>
In the `generate()` method, add the review methods AFTER `add_condition()` and BEFORE the offers block.

Find this section (around line 82):
```php
$this->add_condition( $schema, $product );

// Offers - handle both simple and variable products.
```

Add these two lines between them:
```php
$this->add_condition( $schema, $product );

// Reviews and ratings (REVW-01 through REVW-06).
$this->add_aggregate_rating( $schema, $product );
$this->add_reviews( $schema, $product );

// Offers - handle both simple and variable products.
```

Then run full verification:
1. PHP syntax check: `php -l includes/Schema/Types/class-product-schema.php`
2. Verify all three new methods exist
3. Verify generate() calls both review methods

Create atomic commit with message:
```
feat(10-01): implement AggregateRating and Review schema for products

- Add add_aggregate_rating() with ratingValue from WC average rating
- Add add_reviews() querying approved WooCommerce product reviews
- Add build_review() converting WP_Comment to Review schema
- Products with zero reviews output no review schema (REVW-04)
- Limit individual reviews to 10 for performance

Closes REVW-01, REVW-02, REVW-03, REVW-04, REVW-05, REVW-06
```
  </action>
  <verify>PHP syntax check passes. All methods integrated. Commit created successfully.</verify>
  <done>Complete review schema implementation integrated, verified, and committed.</done>
</task>

</tasks>

<verification>
1. PHP lint passes: `php -l includes/Schema/Types/class-product-schema.php`
2. AggregateRating method exists: `grep -n "add_aggregate_rating" includes/Schema/Types/class-product-schema.php`
3. Reviews method exists: `grep -n "add_reviews" includes/Schema/Types/class-product-schema.php`
4. Build review method exists: `grep -n "build_review" includes/Schema/Types/class-product-schema.php`
5. Generate calls reviews: `grep -B2 -A2 "add_aggregate_rating\|add_reviews" includes/Schema/Types/class-product-schema.php`
6. AggregateRating type: `grep "AggregateRating" includes/Schema/Types/class-product-schema.php`
7. Review type: `grep "'Review'" includes/Schema/Types/class-product-schema.php`
</verification>

<success_criteria>
1. Products with reviews output AggregateRating with ratingValue (WC average) and reviewCount
2. AggregateRating includes bestRating=5 and worstRating=1 for proper scale
3. Products with zero reviews do NOT output aggregateRating property
4. Product schema outputs review array with up to 10 individual Review objects
5. Each Review has author (Person with name), reviewRating (with ratingValue), datePublished
6. Reviews with comment_content include reviewBody (HTML stripped)
7. Reviews without valid rating (1-5) or author are skipped
8. All existing Product schema functionality unchanged (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/10-reviews-ratings/10-01-SUMMARY.md`
</output>
