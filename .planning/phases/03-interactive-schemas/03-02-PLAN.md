---
phase: 03-interactive-schemas
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - includes/Schema/class-schema-ids.php
  - includes/Schema/Types/class-howto-schema.php
  - includes/class-saman-seo-plugin.php
  - blocks/howto/index.js
autonomous: true

must_haves:
  truths:
    - "HowTo schema outputs with step, tool, supply, and totalTime properties"
    - "Adding HowTo block to post automatically generates HowTo schema from block content"
    - "HowTo blocks with showSchema=false do not generate schema"
    - "Time strings like '30 minutes' convert to ISO 8601 duration format"
  artifacts:
    - path: "includes/Schema/Types/class-howto-schema.php"
      provides: "HowTo schema generation from HowTo blocks"
      contains: "class HowTo_Schema extends Abstract_Schema"
    - path: "includes/Schema/class-schema-ids.php"
      provides: "howto() method for @id generation"
      contains: "public static function howto"
    - path: "blocks/howto/index.js"
      provides: "HowTo block without inline schema"
      contains: "save:"
  key_links:
    - from: "includes/Schema/Types/class-howto-schema.php"
      to: "parse_blocks()"
      via: "block parsing in generate()"
      pattern: "parse_blocks.*post_content"
    - from: "includes/class-saman-seo-plugin.php"
      to: "HowTo_Schema"
      via: "registry registration"
      pattern: "register.*howto.*HowTo_Schema"
---

<objective>
Create HowTo schema type that automatically generates from HowTo Gutenberg blocks.

Purpose: Posts containing HowTo blocks should output valid HowTo schema in the unified @graph, enabling rich results for supported search engines (Bing - note Google deprecated HowTo rich results in Sept 2023 but valid schema has no negative impact).

Output:
- HowTo_Schema class extending Abstract_Schema
- Schema_IDs::howto() method
- Registry registration for howto type
- Updated HowTo block with inline schema removed (registry is sole source)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-interactive-schemas/03-RESEARCH.md
@.planning/phases/03-interactive-schemas/03-01-SUMMARY.md

@includes/Schema/class-abstract-schema.php
@includes/Schema/class-schema-ids.php
@includes/Schema/class-schema-context.php
@includes/Schema/Types/class-faqpage-schema.php
@includes/class-saman-seo-plugin.php
@blocks/howto/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Schema_IDs::howto() method</name>
  <files>includes/Schema/class-schema-ids.php</files>
  <action>
Add static method howto() to Schema_IDs class following existing pattern:

```php
/**
 * Get HowTo schema @id for a specific URL.
 *
 * @param string $url The canonical URL of the page.
 * @return string URL#howto identifier.
 */
public static function howto( string $url ): string {
    return $url . '#howto';
}
```

Place after the faqpage() method (added in Plan 01), before the closing brace of the class.
  </action>
  <verify>Grep for "function howto" in class-schema-ids.php confirms method exists</verify>
  <done>Schema_IDs::howto() returns URL#howto format</done>
</task>

<task type="auto">
  <name>Task 2: Create HowTo_Schema class and register in plugin</name>
  <files>
    includes/Schema/Types/class-howto-schema.php
    includes/class-saman-seo-plugin.php
  </files>
  <action>
Create includes/Schema/Types/class-howto-schema.php:

```php
<?php
/**
 * HowTo Schema class.
 *
 * Generates HowTo schema from samanseo/howto Gutenberg blocks.
 * Uses the first HowTo block found in the post.
 *
 * @package Saman\SEO\Schema\Types
 * @since   1.0.0
 */

namespace Saman\SEO\Schema\Types;

use Saman\SEO\Schema\Abstract_Schema;
use Saman\SEO\Schema\Schema_IDs;

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * HowTo schema implementation.
 *
 * Parses HowTo block from post content and generates HowTo schema
 * with steps, tools, supplies, and timing. Uses first block only
 * (multiple HowTo schemas on one page is semantically unclear).
 */
class HowTo_Schema extends Abstract_Schema {

    /**
     * Get the schema @type value.
     *
     * @return string The HowTo type.
     */
    public function get_type() {
        return 'HowTo';
    }

    /**
     * Determine if this schema should be output.
     *
     * Only output if we have a post and it contains HowTo blocks.
     *
     * @return bool True if post contains HowTo blocks.
     */
    public function is_needed(): bool {
        return $this->context->post instanceof \WP_Post
            && has_block( 'samanseo/howto', $this->context->post );
    }

    /**
     * Generate the HowTo schema array.
     *
     * @return array HowTo schema or empty array if no valid data.
     */
    public function generate(): array {
        $howto_data = $this->get_first_howto_block();

        if ( empty( $howto_data ) ) {
            return [];
        }

        $schema = [
            '@type' => $this->get_type(),
            '@id'   => Schema_IDs::howto( $this->context->canonical ),
        ];

        // Add name (required).
        $name = trim( wp_strip_all_tags( $howto_data['title'] ?? '' ) );
        if ( ! empty( $name ) ) {
            $schema['name'] = $name;
        }

        // Add description.
        $description = trim( wp_strip_all_tags( $howto_data['description'] ?? '' ) );
        if ( ! empty( $description ) ) {
            $schema['description'] = $description;
        }

        // Add totalTime in ISO 8601 duration format.
        if ( ! empty( $howto_data['totalTime'] ) ) {
            $iso_time = $this->parse_time_to_iso( $howto_data['totalTime'] );
            if ( $iso_time ) {
                $schema['totalTime'] = $iso_time;
            }
        }

        // Add estimatedCost as MonetaryAmount.
        if ( ! empty( $howto_data['estimatedCost'] ) ) {
            $schema['estimatedCost'] = [
                '@type'    => 'MonetaryAmount',
                'currency' => $howto_data['currency'] ?? 'USD',
                'value'    => $howto_data['estimatedCost'],
            ];
        }

        // Add tools as HowToTool array.
        $tools = $howto_data['tools'] ?? [];
        if ( ! empty( $tools ) && is_array( $tools ) ) {
            $schema['tool'] = array_map(
                fn( $t ) => [
                    '@type' => 'HowToTool',
                    'name'  => $t,
                ],
                array_filter( $tools )
            );
        }

        // Add supplies as HowToSupply array.
        $supplies = $howto_data['supplies'] ?? [];
        if ( ! empty( $supplies ) && is_array( $supplies ) ) {
            $schema['supply'] = array_map(
                fn( $s ) => [
                    '@type' => 'HowToSupply',
                    'name'  => $s,
                ],
                array_filter( $supplies )
            );
        }

        // Add steps as HowToStep array.
        $steps = $howto_data['steps'] ?? [];
        if ( ! empty( $steps ) ) {
            $built_steps = $this->build_steps( $steps );
            if ( ! empty( $built_steps ) ) {
                $schema['step'] = $built_steps;
            }
        }

        return $schema;
    }

    /**
     * Get the first HowTo block data from post content.
     *
     * Only uses the first HowTo block with showSchema enabled.
     * Multiple HowTo schemas on one page is semantically unclear.
     *
     * @return array|null Block attributes or null if not found.
     */
    private function get_first_howto_block(): ?array {
        $blocks = parse_blocks( $this->context->post->post_content );
        return $this->find_howto_block( $blocks );
    }

    /**
     * Recursively find the first HowTo block (handles inner blocks).
     *
     * @param array $blocks Blocks to search.
     * @return array|null Block attributes or null if not found.
     */
    private function find_howto_block( array $blocks ): ?array {
        foreach ( $blocks as $block ) {
            if ( 'samanseo/howto' === $block['blockName'] ) {
                $attrs = $block['attrs'] ?? [];

                // Respect showSchema toggle.
                if ( ! empty( $attrs['showSchema'] ) ) {
                    return $attrs;
                }
            }

            // Check nested blocks.
            if ( ! empty( $block['innerBlocks'] ) ) {
                $found = $this->find_howto_block( $block['innerBlocks'] );
                if ( $found ) {
                    return $found;
                }
            }
        }

        return null;
    }

    /**
     * Build HowToStep array from steps data.
     *
     * @param array $steps Steps from block attributes.
     * @return array Array of HowToStep objects.
     */
    private function build_steps( array $steps ): array {
        $result   = [];
        $position = 1;

        foreach ( $steps as $step ) {
            $title       = trim( wp_strip_all_tags( $step['title'] ?? '' ) );
            $description = trim( wp_strip_all_tags( $step['description'] ?? '' ) );

            // Skip steps with no content.
            if ( empty( $title ) && empty( $description ) ) {
                continue;
            }

            $step_schema = [
                '@type'    => 'HowToStep',
                'position' => $position,
            ];

            if ( ! empty( $title ) ) {
                $step_schema['name'] = $title;
            }

            if ( ! empty( $description ) ) {
                $step_schema['text'] = $description;
            }

            if ( ! empty( $step['image'] ) ) {
                $step_schema['image'] = $step['image'];
            }

            $result[] = $step_schema;
            $position++;
        }

        return $result;
    }

    /**
     * Parse human-readable time string to ISO 8601 duration.
     *
     * Supports formats like "30 minutes", "2 hours", "30 min", "2 h".
     *
     * @param string $time_str The time string to parse.
     * @return string|null ISO 8601 duration (e.g., "PT30M") or null if unparseable.
     */
    private function parse_time_to_iso( string $time_str ): ?string {
        if ( preg_match( '/(\d+)\s*(min|minute|minutes|m)\b/i', $time_str, $match ) ) {
            return 'PT' . (int) $match[1] . 'M';
        }
        if ( preg_match( '/(\d+)\s*(hour|hours|h)\b/i', $time_str, $match ) ) {
            return 'PT' . (int) $match[1] . 'H';
        }
        return null;
    }
}
```

Then update includes/class-saman-seo-plugin.php:

1. Add use statement with other Schema use statements:
   ```php
   use Saman\SEO\Schema\Types\HowTo_Schema;
   ```

2. Add registration after FAQPage_Schema (same priority 18):
   ```php
   $registry->register(
       'howto',
       HowTo_Schema::class,
       [
           'label'    => __( 'How To', 'saman-seo' ),
           'priority' => 18,
       ]
   );
   ```
  </action>
  <verify>
1. File exists: includes/Schema/Types/class-howto-schema.php
2. Grep "HowTo_Schema" in class-saman-seo-plugin.php shows use statement and registration
3. PHP syntax check passes: php -l includes/Schema/Types/class-howto-schema.php
  </verify>
  <done>HowTo_Schema class created and registered at priority 18</done>
</task>

<task type="auto">
  <name>Task 3: Remove inline schema from HowTo block save output</name>
  <files>blocks/howto/index.js</files>
  <action>
Modify the save function in blocks/howto/index.js to remove the inline JSON-LD script output.

The registry will now be the sole source of HowTo schema. Keep the showSchema attribute, but remove the inline script generation.

Changes to make in the save function:

1. Remove the parseTime function (only used for inline schema)
2. Remove the schema building code
3. Remove the script element that outputs JSON-LD
4. Keep all visual HTML output (the structured content with microdata)

The save function should become:

```javascript
save: function( { attributes } ) {
    const { title, description, totalTime, estimatedCost, currency, steps, tools, supplies, showSchema } = attributes;
    const blockProps = useBlockProps.save( { className: 'samanseo-howto' } );

    // Filter out empty steps
    const validSteps = steps.filter( step => step.title || step.description );

    if ( validSteps.length === 0 ) {
        return null;
    }

    // Parse time to ISO 8601 duration (for microdata only).
    const parseTime = ( timeStr ) => {
        if ( ! timeStr ) return null;
        const match = timeStr.match( /(\d+)\s*(min|hour|h|m)/i );
        if ( match ) {
            const num = parseInt( match[ 1 ] );
            const unit = match[ 2 ].toLowerCase();
            if ( unit === 'h' || unit === 'hour' ) {
                return 'PT' + num + 'H';
            }
            return 'PT' + num + 'M';
        }
        return null;
    };

    // Schema JSON-LD output removed - handled by PHP registry.
    // showSchema attribute still controls whether registry includes this block.

    return el(
        'div',
        blockProps,
        el(
            'div',
            { className: 'samanseo-howto-content', itemScope: true, itemType: 'https://schema.org/HowTo' },
            title && el(
                'h3',
                { className: 'samanseo-howto-title', itemProp: 'name' },
                el( RichText.Content, { value: title } )
            ),
            description && el(
                'p',
                { className: 'samanseo-howto-description', itemProp: 'description' },
                el( RichText.Content, { value: description } )
            ),
            ( tools.length > 0 || supplies.length > 0 || totalTime || estimatedCost ) && el(
                'div',
                { className: 'samanseo-howto-meta' },
                totalTime && el(
                    'span',
                    { className: 'samanseo-howto-time' },
                    __( 'Time: ', 'saman-seo' ),
                    el( 'span', { itemProp: 'totalTime', content: parseTime( totalTime ) }, totalTime )
                ),
                estimatedCost && el(
                    'span',
                    { className: 'samanseo-howto-cost', itemProp: 'estimatedCost', itemScope: true, itemType: 'https://schema.org/MonetaryAmount' },
                    __( 'Cost: ', 'saman-seo' ),
                    el( 'span', { itemProp: 'value' }, estimatedCost ),
                    el( 'span', { itemProp: 'currency', content: currency }, ' ' + currency )
                ),
                tools.length > 0 && el(
                    'div',
                    { className: 'samanseo-howto-tools' },
                    el( 'strong', null, __( 'Tools: ', 'saman-seo' ) ),
                    tools.map( ( tool, i ) => el( 'span', { key: i, itemProp: 'tool', itemScope: true, itemType: 'https://schema.org/HowToTool' },
                        el( 'span', { itemProp: 'name' }, tool ),
                        i < tools.length - 1 ? ', ' : ''
                    ) )
                ),
                supplies.length > 0 && el(
                    'div',
                    { className: 'samanseo-howto-supplies' },
                    el( 'strong', null, __( 'Supplies: ', 'saman-seo' ) ),
                    supplies.map( ( supply, i ) => el( 'span', { key: i, itemProp: 'supply', itemScope: true, itemType: 'https://schema.org/HowToSupply' },
                        el( 'span', { itemProp: 'name' }, supply ),
                        i < supplies.length - 1 ? ', ' : ''
                    ) )
                )
            ),
            el(
                'ol',
                { className: 'samanseo-howto-steps' },
                validSteps.map( ( step, index ) =>
                    el(
                        'li',
                        {
                            key: index,
                            className: 'samanseo-howto-step',
                            itemProp: 'step',
                            itemScope: true,
                            itemType: 'https://schema.org/HowToStep',
                        },
                        el( 'meta', { itemProp: 'position', content: index + 1 } ),
                        step.image && el( 'img', {
                            className: 'samanseo-howto-step-image',
                            src: step.image,
                            alt: step.title.replace( /<[^>]*>/g, '' ),
                            itemProp: 'image',
                        } ),
                        step.title && el(
                            'strong',
                            { className: 'samanseo-howto-step-title', itemProp: 'name' },
                            el( RichText.Content, { value: step.title } )
                        ),
                        step.description && el(
                            'div',
                            { className: 'samanseo-howto-step-description', itemProp: 'text' },
                            el( RichText.Content, { value: step.description } )
                        )
                    )
                )
            )
        )
    );
},
```

Key changes:
- Removed: The schema object construction
- Removed: The `showSchema && el('script', ...)` element
- Added: Comment noting schema is handled by PHP registry
- Kept: All visual HTML output with microdata attributes
- Kept: parseTime function (still used for microdata content attribute)
  </action>
  <verify>
1. Grep "application/ld+json" in blocks/howto/index.js returns NO matches (inline schema removed)
2. Grep "samanseo-howto-content" in blocks/howto/index.js still exists (visual output preserved)
3. The showSchema attribute is still defined in attributes (for registry to check)
  </verify>
  <done>HowTo block no longer outputs inline JSON-LD; registry is sole schema source</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema_IDs method exists:**
   ```bash
   grep -n "function howto" includes/Schema/class-schema-ids.php
   ```

2. **HowTo_Schema class exists and is valid PHP:**
   ```bash
   php -l includes/Schema/Types/class-howto-schema.php
   ```

3. **Registration in plugin:**
   ```bash
   grep -n "howto" includes/class-saman-seo-plugin.php
   ```

4. **Inline schema removed from block:**
   ```bash
   grep "application/ld+json" blocks/howto/index.js || echo "No inline schema (correct)"
   ```

5. **Visual microdata preserved:**
   ```bash
   grep "itemType.*HowTo" blocks/howto/index.js
   ```

6. **Both interactive schemas registered:**
   ```bash
   grep -E "faqpage|howto" includes/class-saman-seo-plugin.php
   ```
</verification>

<success_criteria>
- Schema_IDs::howto() method returns URL#howto
- HowTo_Schema class extends Abstract_Schema with is_needed() and generate()
- HowTo_Schema uses first HowTo block only (multiple would need @id differentiation)
- HowTo_Schema includes step, tool, supply, totalTime, estimatedCost properties
- HowTo_Schema parses time strings to ISO 8601 duration format
- HowTo_Schema respects showSchema attribute (skips blocks where false)
- HowTo registered in plugin at priority 18
- HowTo block save() no longer outputs inline JSON-LD script
- HowTo block retains visual HTML with microdata attributes
</success_criteria>

<output>
After completion, create `.planning/phases/03-interactive-schemas/03-02-SUMMARY.md`
</output>
