---
phase: 03-interactive-schemas
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Schema/class-schema-ids.php
  - includes/Schema/Types/class-faqpage-schema.php
  - includes/class-saman-seo-plugin.php
  - blocks/faq/index.js
autonomous: true

must_haves:
  truths:
    - "FAQPage schema outputs with mainEntity containing Question/Answer pairs"
    - "Adding FAQ block to post automatically generates FAQPage schema from block content"
    - "FAQ blocks with showSchema=false do not contribute to schema"
    - "Multiple FAQ blocks in same post combine into single FAQPage mainEntity"
  artifacts:
    - path: "includes/Schema/Types/class-faqpage-schema.php"
      provides: "FAQPage schema generation from FAQ blocks"
      contains: "class FAQPage_Schema extends Abstract_Schema"
    - path: "includes/Schema/class-schema-ids.php"
      provides: "faqpage() method for @id generation"
      contains: "public static function faqpage"
    - path: "blocks/faq/index.js"
      provides: "FAQ block without inline schema"
      contains: "save:"
  key_links:
    - from: "includes/Schema/Types/class-faqpage-schema.php"
      to: "parse_blocks()"
      via: "block parsing in generate()"
      pattern: "parse_blocks.*post_content"
    - from: "includes/class-saman-seo-plugin.php"
      to: "FAQPage_Schema"
      via: "registry registration"
      pattern: "register.*faqpage.*FAQPage_Schema"
---

<objective>
Create FAQPage schema type that automatically generates from FAQ Gutenberg blocks.

Purpose: Posts containing FAQ blocks should output valid FAQPage schema in the unified @graph, enabling rich results for supported search engines (Bing, potentially Google for gov/health sites).

Output:
- FAQPage_Schema class extending Abstract_Schema
- Schema_IDs::faqpage() method
- Registry registration for faqpage type
- Updated FAQ block with inline schema removed (registry is sole source)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-interactive-schemas/03-RESEARCH.md

@includes/Schema/class-abstract-schema.php
@includes/Schema/class-schema-ids.php
@includes/Schema/class-schema-context.php
@includes/Schema/class-schema-registry.php
@includes/class-saman-seo-plugin.php
@blocks/faq/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Schema_IDs::faqpage() method</name>
  <files>includes/Schema/class-schema-ids.php</files>
  <action>
Add static method faqpage() to Schema_IDs class following existing pattern:

```php
/**
 * Get FAQPage schema @id for a specific URL.
 *
 * @param string $url The canonical URL of the page.
 * @return string URL#faqpage identifier.
 */
public static function faqpage( string $url ): string {
    return $url . '#faqpage';
}
```

Place after the existing breadcrumb() method, before the closing brace of the class.
  </action>
  <verify>Grep for "function faqpage" in class-schema-ids.php confirms method exists</verify>
  <done>Schema_IDs::faqpage() returns URL#faqpage format</done>
</task>

<task type="auto">
  <name>Task 2: Create FAQPage_Schema class and register in plugin</name>
  <files>
    includes/Schema/Types/class-faqpage-schema.php
    includes/class-saman-seo-plugin.php
  </files>
  <action>
Create includes/Schema/Types/class-faqpage-schema.php:

```php
<?php
/**
 * FAQPage Schema class.
 *
 * Generates FAQPage schema from samanseo/faq Gutenberg blocks.
 * Combines questions from all FAQ blocks in the post.
 *
 * @package Saman\SEO\Schema\Types
 * @since   1.0.0
 */

namespace Saman\SEO\Schema\Types;

use Saman\SEO\Schema\Abstract_Schema;
use Saman\SEO\Schema\Schema_IDs;

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * FAQPage schema implementation.
 *
 * Parses FAQ blocks from post content and generates FAQPage schema
 * with Question/Answer pairs in mainEntity. Respects showSchema
 * attribute on individual blocks.
 */
class FAQPage_Schema extends Abstract_Schema {

    /**
     * Get the schema @type value.
     *
     * @return string The FAQPage type.
     */
    public function get_type() {
        return 'FAQPage';
    }

    /**
     * Determine if this schema should be output.
     *
     * Only output if we have a post and it contains FAQ blocks.
     *
     * @return bool True if post contains FAQ blocks.
     */
    public function is_needed(): bool {
        return $this->context->post instanceof \WP_Post
            && has_block( 'samanseo/faq', $this->context->post );
    }

    /**
     * Generate the FAQPage schema array.
     *
     * @return array FAQPage schema or empty array if no valid questions.
     */
    public function generate(): array {
        $questions = $this->collect_questions_from_blocks();

        if ( empty( $questions ) ) {
            return [];
        }

        return [
            '@type'      => $this->get_type(),
            '@id'        => Schema_IDs::faqpage( $this->context->canonical ),
            'mainEntity' => $questions,
        ];
    }

    /**
     * Collect all FAQ questions from FAQ blocks in post content.
     *
     * Iterates through all samanseo/faq blocks, respects showSchema
     * attribute, and combines all valid Q&A pairs.
     *
     * @return array Array of Question objects for mainEntity.
     */
    private function collect_questions_from_blocks(): array {
        $blocks    = parse_blocks( $this->context->post->post_content );
        $questions = [];

        $this->extract_faq_blocks( $blocks, $questions );

        return $questions;
    }

    /**
     * Recursively extract FAQ blocks (handles inner blocks).
     *
     * @param array $blocks    Blocks to search.
     * @param array $questions Reference to questions array to populate.
     */
    private function extract_faq_blocks( array $blocks, array &$questions ): void {
        foreach ( $blocks as $block ) {
            if ( 'samanseo/faq' === $block['blockName'] ) {
                $attrs = $block['attrs'] ?? [];

                // Respect showSchema toggle - only include if true.
                if ( empty( $attrs['showSchema'] ) ) {
                    continue;
                }

                $faqs = $attrs['faqs'] ?? [];
                foreach ( $faqs as $faq ) {
                    $q = trim( wp_strip_all_tags( $faq['question'] ?? '' ) );
                    $a = trim( wp_strip_all_tags( $faq['answer'] ?? '' ) );

                    if ( ! empty( $q ) && ! empty( $a ) ) {
                        $questions[] = [
                            '@type'          => 'Question',
                            'name'           => $q,
                            'acceptedAnswer' => [
                                '@type' => 'Answer',
                                'text'  => $a,
                            ],
                        ];
                    }
                }
            }

            // Handle nested blocks (e.g., inside columns, groups).
            if ( ! empty( $block['innerBlocks'] ) ) {
                $this->extract_faq_blocks( $block['innerBlocks'], $questions );
            }
        }
    }
}
```

Then update includes/class-saman-seo-plugin.php:

1. Add use statement at top with other Schema use statements:
   ```php
   use Saman\SEO\Schema\Types\FAQPage_Schema;
   ```

2. Add registration after the content schemas block (after NewsArticle, before Breadcrumb):
   ```php
   // Interactive schemas (priority 18 - after content schemas 15, before Breadcrumb 20).
   $registry->register(
       'faqpage',
       FAQPage_Schema::class,
       [
           'label'    => __( 'FAQ Page', 'saman-seo' ),
           'priority' => 18,
       ]
   );
   ```
  </action>
  <verify>
1. File exists: includes/Schema/Types/class-faqpage-schema.php
2. Grep "FAQPage_Schema" in class-saman-seo-plugin.php shows use statement and registration
3. PHP syntax check passes: php -l includes/Schema/Types/class-faqpage-schema.php
  </verify>
  <done>FAQPage_Schema class created and registered at priority 18</done>
</task>

<task type="auto">
  <name>Task 3: Remove inline schema from FAQ block save output</name>
  <files>blocks/faq/index.js</files>
  <action>
Modify the save function in blocks/faq/index.js to remove the inline JSON-LD script output.

The registry will now be the sole source of FAQPage schema. Keep the showSchema attribute (users may still want to disable schema via the toggle), but remove the inline script generation.

Changes to make in the save function:

1. Remove the schema building code (lines that create the schema object)
2. Remove the script element that outputs JSON-LD
3. Keep all visual HTML output (the details/summary accordion structure)

The save function should become:

```javascript
save: function( { attributes } ) {
    const { faqs, showSchema, style } = attributes;
    const blockProps = useBlockProps.save( { className: 'samanseo-faq' } );

    // Filter out empty FAQs
    const validFaqs = faqs.filter( faq => faq.question && faq.answer );

    if ( validFaqs.length === 0 ) {
        return null;
    }

    // Schema output removed - handled by PHP registry.
    // showSchema attribute still controls whether registry includes this block.

    return el(
        'div',
        blockProps,
        el(
            'div',
            { className: 'samanseo-faq-list', itemScope: true, itemType: 'https://schema.org/FAQPage' },
            validFaqs.map( ( faq, index ) =>
                el(
                    'details',
                    {
                        key: index,
                        className: 'samanseo-faq-item',
                        itemScope: true,
                        itemProp: 'mainEntity',
                        itemType: 'https://schema.org/Question',
                    },
                    el(
                        'summary',
                        { className: 'samanseo-faq-question', itemProp: 'name' },
                        el( RichText.Content, { value: faq.question } )
                    ),
                    el(
                        'div',
                        {
                            className: 'samanseo-faq-answer',
                            itemScope: true,
                            itemProp: 'acceptedAnswer',
                            itemType: 'https://schema.org/Answer',
                        },
                        el(
                            'div',
                            { itemProp: 'text' },
                            el( RichText.Content, { value: faq.answer } )
                        )
                    )
                )
            )
        )
    );
},
```

Key changes:
- Removed: `const schema = showSchema ? { ... } : null;`
- Removed: The `showSchema && el('script', ...)` element
- Added: Comment noting schema is handled by PHP registry
- Kept: All visual HTML output with microdata (itemScope, itemType, itemProp)
  </action>
  <verify>
1. Grep "application/ld+json" in blocks/faq/index.js returns NO matches (inline schema removed)
2. Grep "samanseo-faq-list" in blocks/faq/index.js still exists (visual output preserved)
3. The showSchema attribute is still defined in attributes (for registry to check)
  </verify>
  <done>FAQ block no longer outputs inline JSON-LD; registry is sole schema source</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema_IDs method exists:**
   ```bash
   grep -n "function faqpage" includes/Schema/class-schema-ids.php
   ```

2. **FAQPage_Schema class exists and is valid PHP:**
   ```bash
   php -l includes/Schema/Types/class-faqpage-schema.php
   ```

3. **Registration in plugin:**
   ```bash
   grep -n "faqpage" includes/class-saman-seo-plugin.php
   ```

4. **Inline schema removed from block:**
   ```bash
   grep "application/ld+json" blocks/faq/index.js || echo "No inline schema (correct)"
   ```

5. **Visual microdata preserved:**
   ```bash
   grep "itemType.*FAQPage" blocks/faq/index.js
   ```
</verification>

<success_criteria>
- Schema_IDs::faqpage() method returns URL#faqpage
- FAQPage_Schema class extends Abstract_Schema with is_needed() and generate()
- FAQPage_Schema parses all FAQ blocks and combines questions into mainEntity
- FAQPage_Schema respects showSchema attribute (skips blocks where false)
- FAQPage registered in plugin at priority 18
- FAQ block save() no longer outputs inline JSON-LD script
- FAQ block retains visual HTML with microdata attributes
</success_criteria>

<output>
After completion, create `.planning/phases/03-interactive-schemas/03-01-SUMMARY.md`
</output>
