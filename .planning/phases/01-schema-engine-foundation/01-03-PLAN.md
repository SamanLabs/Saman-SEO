---
phase: 01-schema-engine-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - includes/Schema/Types/class-website-schema.php
  - includes/Schema/Types/class-webpage-schema.php
  - includes/Schema/Types/class-breadcrumb-schema.php
  - includes/Schema/Types/class-organization-schema.php
  - includes/Schema/Types/class-person-schema.php
  - includes/class-saman-seo-service-jsonld.php
  - includes/class-saman-seo-plugin.php
autonomous: true

must_haves:
  truths:
    - "WebSite schema outputs with @id, url, name, description, publisher reference"
    - "WebPage schema outputs for posts with dates, breadcrumb reference, primaryImageOfPage"
    - "Breadcrumb schema outputs ListItem array with proper positioning"
    - "Organization/Person schemas output based on Knowledge Graph settings"
    - "Existing JSON-LD output remains unchanged after migration"
  artifacts:
    - path: "includes/Schema/Types/class-website-schema.php"
      provides: "WebSite schema implementation"
      contains: "class WebSite_Schema extends Abstract_Schema"
    - path: "includes/Schema/Types/class-webpage-schema.php"
      provides: "WebPage schema implementation"
      contains: "class WebPage_Schema extends Abstract_Schema"
    - path: "includes/Schema/Types/class-breadcrumb-schema.php"
      provides: "Breadcrumb schema implementation"
      contains: "class Breadcrumb_Schema extends Abstract_Schema"
    - path: "includes/Schema/Types/class-organization-schema.php"
      provides: "Organization schema implementation"
      contains: "class Organization_Schema extends Abstract_Schema"
    - path: "includes/Schema/Types/class-person-schema.php"
      provides: "Person schema implementation"
      contains: "class Person_Schema extends Abstract_Schema"
  key_links:
    - from: "includes/Schema/Types/*.php"
      to: "includes/Schema/class-abstract-schema.php"
      via: "extends Abstract_Schema"
      pattern: "extends Abstract_Schema"
    - from: "includes/class-saman-seo-service-jsonld.php"
      to: "includes/Schema/class-schema-graph-manager.php"
      via: "delegates to graph manager"
      pattern: "Schema_Graph_Manager"
    - from: "includes/class-saman-seo-plugin.php"
      to: "includes/Schema/class-schema-registry.php"
      via: "registers schema types on boot"
      pattern: "Schema_Registry::instance"
---

<objective>
Migrate existing WebSite, WebPage, Breadcrumb, Organization, and Person schemas to the new engine architecture.

Purpose: This completes the foundation phase by proving the new architecture works with real schemas. The existing JsonLD service output must remain identical to ensure backward compatibility, while the new extensible architecture is now in place for future schema types.

Output: Five schema type classes in includes/Schema/Types/, updated JsonLD service that delegates to the new engine, and registry integration in the plugin bootstrap.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-engine-foundation/01-RESEARCH.md
@.planning/phases/01-schema-engine-foundation/01-01-SUMMARY.md
@.planning/phases/01-schema-engine-foundation/01-02-SUMMARY.md
@includes/class-saman-seo-service-jsonld.php (existing implementation to migrate)
@includes/class-saman-seo-plugin.php (bootstrap to modify)

Key reference: Current JsonLD service methods to preserve:
- WebSite with publisher reference
- WebPage with dates, breadcrumb ref, primaryImageOfPage
- BreadcrumbList with ListItem array
- Organization with logo, local SEO data, social profiles
- Person with image, jobTitle, social profiles
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Organization and Person schema types</name>
  <files>
includes/Schema/Types/class-organization-schema.php
includes/Schema/Types/class-person-schema.php
  </files>
  <action>
Create both publisher entity schemas by extracting logic from current JsonLD service.

**Organization_Schema** (class-organization-schema.php):
- Namespace: `Saman\SEO\Schema\Types`
- Extends: `Abstract_Schema`
- `get_type()`: returns 'Organization'
- `is_needed()`: returns `get_option('SAMAN_SEO_homepage_knowledge_type', 'organization') === 'organization'`
- `generate()`: Port the `get_organization_schema()` logic from JsonLD service:
  - @type, @id (use Schema_IDs::organization())
  - name (from option or site name fallback)
  - url (home_url)
  - logo ImageObject (from option or site icon)
  - telephone, email, description from local SEO options
  - address PostalAddress from local SEO options (street, city, state, zip, country)
  - sameAs array from social profiles
- Private helper: `get_social_profiles()` (port from JsonLD service)

**Person_Schema** (class-person-schema.php):
- Namespace: `Saman\SEO\Schema\Types`
- Extends: `Abstract_Schema`
- `get_type()`: returns 'Person'
- `is_needed()`: returns `get_option('SAMAN_SEO_homepage_knowledge_type', 'organization') === 'person'`
- `generate()`: Port the `get_person_schema()` logic:
  - @type, @id (use Schema_IDs::person())
  - name (from option or site name fallback)
  - image ImageObject (if set)
  - jobTitle (if set)
  - url (person URL option or home_url)
  - sameAs from social profiles

Import Schema_IDs for @id generation. Do NOT include @context in output.
  </action>
  <verify>
Run `ls includes/Schema/Types/` and verify both files exist. Run `grep "extends Abstract_Schema" includes/Schema/Types/class-*-schema.php | wc -l` to verify both extend base class.
  </verify>
  <done>Organization and Person schemas ready for Knowledge Graph publisher support.</done>
</task>

<task type="auto">
  <name>Task 2: Create WebSite, WebPage, and Breadcrumb schema types</name>
  <files>
includes/Schema/Types/class-website-schema.php
includes/Schema/Types/class-webpage-schema.php
includes/Schema/Types/class-breadcrumb-schema.php
  </files>
  <action>
Create the three core page schemas.

**WebSite_Schema** (class-website-schema.php):
- `get_type()`: returns 'WebSite'
- `is_needed()`: returns true (always output WebSite schema)
- `generate()`:
  - @type, @id (Schema_IDs::website())
  - url (context->site_url)
  - name (context->site_name)
  - description (from SAMAN_SEO_default_meta_description option or bloginfo description)
  - publisher: `['@id' => $this->get_publisher_id()]`
- Private helper `get_publisher_id()`:
  - Check SAMAN_SEO_homepage_knowledge_type option
  - Return Schema_IDs::person() or Schema_IDs::organization()

**WebPage_Schema** (class-webpage-schema.php):
- `get_type()`: returns 'WebPage'
- `is_needed()`: returns `$this->context->post instanceof \WP_Post`
- `generate()`:
  - @type, @id (Schema_IDs::webpage(context->canonical))
  - url (context->canonical)
  - name (get_the_title)
  - datePublished, dateModified (DATE_W3C format)
  - isPartOf: `['@id' => Schema_IDs::website()]`
  - breadcrumb: `['@id' => Schema_IDs::breadcrumb(context->canonical)]`
  - primaryImageOfPage: ImageObject with thumbnail or default OG image

**Breadcrumb_Schema** (class-breadcrumb-schema.php):
- `get_type()`: returns 'BreadcrumbList'
- `is_needed()`: returns `$this->context->post instanceof \WP_Post`
- `generate()`: Port breadcrumb_ld() logic:
  - @type, @id (Schema_IDs::breadcrumb(context->canonical))
  - itemListElement array with ListItems
  - Home crumb first (position 1)
  - Ancestors in reverse order
  - Current page last
  - Each ListItem: @type, position, name, item (URL)

All use namespace `Saman\SEO\Schema\Types`, extend Abstract_Schema, use Schema_IDs.
  </action>
  <verify>
Run `ls includes/Schema/Types/*.php | wc -l` and verify 5 files. Run `grep "class.*_Schema extends Abstract_Schema" includes/Schema/Types/*.php` to verify all extend base.
  </verify>
  <done>Core page schemas (WebSite, WebPage, Breadcrumb) match existing output structure.</done>
</task>

<task type="auto">
  <name>Task 3: Wire up schema engine in JsonLD service and plugin bootstrap</name>
  <files>
includes/class-saman-seo-service-jsonld.php
includes/class-saman-seo-plugin.php
  </files>
  <action>
Modify existing files to use the new schema engine.

**JsonLD service modifications** (class-saman-seo-service-jsonld.php):
1. Add use statements at top:
   ```php
   use Saman\SEO\Schema\Schema_Registry;
   use Saman\SEO\Schema\Schema_Graph_Manager;
   use Saman\SEO\Schema\Schema_Context;
   ```

2. Keep the boot() method unchanged (still hooks SAMAN_SEO_jsonld filter)

3. Replace build_payload() method body:
   ```php
   public function build_payload($payload, $post) {
       $context = $post ? Schema_Context::from_post($post) : Schema_Context::from_current();
       $registry = Schema_Registry::instance();
       $manager = new Schema_Graph_Manager($registry);

       return $manager->build($context);
   }
   ```

4. KEEP the existing private methods (get_organization_schema, get_person_schema, breadcrumb_ld, get_social_profiles) for now - they serve as reference and may be needed by third-party code that calls them directly. Add @deprecated PHPDoc to each.

**Plugin bootstrap modifications** (class-saman-seo-plugin.php):
1. Add use statements after existing ones:
   ```php
   use Saman\SEO\Schema\Schema_Registry;
   use Saman\SEO\Schema\Types\WebSite_Schema;
   use Saman\SEO\Schema\Types\WebPage_Schema;
   use Saman\SEO\Schema\Types\Breadcrumb_Schema;
   use Saman\SEO\Schema\Types\Organization_Schema;
   use Saman\SEO\Schema\Types\Person_Schema;
   ```

2. In boot() method, BEFORE registering the jsonld service, add schema type registrations:
   ```php
   // Register core schema types
   $registry = Schema_Registry::instance();
   $registry->register('website', WebSite_Schema::class, ['priority' => 1]);
   $registry->register('organization', Organization_Schema::class, ['priority' => 2]);
   $registry->register('person', Person_Schema::class, ['priority' => 2]);
   $registry->register('webpage', WebPage_Schema::class, ['priority' => 10]);
   $registry->register('breadcrumb', Breadcrumb_Schema::class, ['priority' => 20]);
   ```

The priority ordering ensures: WebSite first, then Organization/Person, then WebPage, then Breadcrumb (matching current output order).
  </action>
  <verify>
1. Run `grep "Schema_Registry::instance" includes/class-saman-seo-plugin.php` to verify registry usage
2. Run `grep "Schema_Graph_Manager" includes/class-saman-seo-service-jsonld.php` to verify delegation
3. Run `grep "@deprecated" includes/class-saman-seo-service-jsonld.php | wc -l` to verify deprecated methods marked
  </verify>
  <done>Schema engine integrated: JsonLD service delegates to Graph Manager, core types registered in bootstrap.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Structure: `ls includes/Schema/Types/*.php` shows 5 schema type files
2. Inheritance: All Types extend Abstract_Schema
3. Registry: Plugin boot() registers 5 core types
4. Delegation: JsonLD service uses Schema_Graph_Manager
5. Output parity: JSON-LD output structure unchanged (same @graph members)

Manual verification (for SUMMARY):
- Visit a post page
- View source, find JSON-LD script
- Verify @context at root only
- Verify @graph contains WebSite, Organization/Person, WebPage, BreadcrumbList
</verification>

<success_criteria>
- [ ] 5 schema type files in includes/Schema/Types/
- [ ] Organization_Schema outputs when knowledge_type is 'organization'
- [ ] Person_Schema outputs when knowledge_type is 'person'
- [ ] WebSite_Schema always outputs with publisher reference
- [ ] WebPage_Schema outputs for posts with proper references
- [ ] Breadcrumb_Schema outputs ListItems with correct positioning
- [ ] JsonLD service delegates to Schema_Graph_Manager
- [ ] Plugin boot() registers core schema types with priorities
- [ ] Legacy methods marked @deprecated but kept for backward compat
- [ ] @context only at root level in final output
- [ ] SAMAN_SEO_jsonld_graph filter still works (backward compat)
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-engine-foundation/01-03-SUMMARY.md`
</output>
