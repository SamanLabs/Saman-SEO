---
phase: 05-admin-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Api/class-schema-preview-controller.php
  - includes/class-saman-seo-admin-v2.php
  - includes/class-saman-seo-service-post-meta.php
autonomous: true

must_haves:
  truths:
    - "REST endpoint returns JSON-LD preview for a given post ID"
    - "schema_type is persisted when user saves a post via Gutenberg"
    - "Schema_Context respects schema_type override from request parameter"
  artifacts:
    - path: "includes/Api/class-schema-preview-controller.php"
      provides: "REST endpoint for schema preview"
      exports: ["Schema_Preview_Controller"]
      contains: "register_rest_route"
    - path: "includes/class-saman-seo-service-post-meta.php"
      provides: "Post meta with schema_type field"
      contains: "schema_type"
  key_links:
    - from: "includes/Api/class-schema-preview-controller.php"
      to: "Schema_Graph_Manager::build()"
      via: "instantiation and method call"
      pattern: "new Schema_Graph_Manager.*->build"
    - from: "includes/class-saman-seo-admin-v2.php"
      to: "Schema_Preview_Controller"
      via: "controller registration"
      pattern: "Schema_Preview.*register_routes"
---

<objective>
Create the REST API endpoint for schema preview and add schema_type to post meta persistence.

Purpose: Enable the editor sidebar to fetch live JSON-LD preview and save schema type per-post
Output: Schema_Preview_Controller with POST /schema/preview/{post_id} endpoint, updated Post_Meta with schema_type field
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-ui/05-RESEARCH.md

@includes/Api/class-rest-controller.php
@includes/Schema/class-schema-context.php
@includes/Schema/class-schema-registry.php
@includes/Schema/class-schema-graph-manager.php
@includes/class-saman-seo-service-post-meta.php
@includes/class-saman-seo-admin-v2.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Schema_Preview_Controller</name>
  <files>
    includes/Api/class-schema-preview-controller.php
    includes/class-saman-seo-admin-v2.php
  </files>
  <action>
Create `includes/Api/class-schema-preview-controller.php`:

1. Extend `REST_Controller` base class (namespace `Saman\SEO\Api`)
2. Set `$rest_base = 'schema/preview'`
3. Implement `register_routes()`:
   - Route: `POST /saman-seo/v1/schema/preview/(?P<post_id>\d+)`
   - Args: `post_id` (required, integer), `schema_type` (optional, string)
   - Permission: `edit_post` capability for the specific post (not `manage_options` - editors need access)

4. Implement `get_preview($request)` method:
   - Get post_id from URL param
   - Get schema_type from body param (optional override)
   - Validate post exists, return 404 if not
   - Create Schema_Context via `Schema_Context::from_post($post)`
   - If schema_type provided, override: `$context->schema_type = $schema_type`
   - Build graph: `$manager = new Schema_Graph_Manager(Schema_Registry::instance()); $graph = $manager->build($context);`
   - Return success response with `json_ld` (the graph) and `schema_type` (resolved type)

5. Implement `permission_check_post($request)`:
   - Get post_id from request
   - Return `current_user_can('edit_post', $post_id)`

Register in `includes/class-saman-seo-admin-v2.php`:
- Add `'Schema_Preview' => 'class-schema-preview-controller.php'` to the $controllers array in `load_rest_controllers()` method (around line 400)

Use existing patterns from class-audit-controller.php or class-dashboard-controller.php as reference.
  </action>
  <verify>
Verify with WP-CLI or REST API test:
```bash
# From plugin root, test the endpoint exists (will fail auth but shows route registered)
wp rest route list --path=/saman-seo/v1/schema/preview/
```

Or check that the file parses without errors:
```bash
php -l includes/Api/class-schema-preview-controller.php
```
  </verify>
  <done>
- Schema_Preview_Controller file exists with register_routes() and get_preview() methods
- Controller registered in Admin_V2::load_rest_controllers()
- Endpoint POST /saman-seo/v1/schema/preview/{post_id} is registered
  </done>
</task>

<task type="auto">
  <name>Task 2: Add schema_type to Post_Meta</name>
  <files>includes/class-saman-seo-service-post-meta.php</files>
  <action>
Update `includes/class-saman-seo-service-post-meta.php`:

1. In `register_meta()` method, add `schema_type` to the `$schema['properties']` array:
   ```php
   'schema_type' => [
       'type' => 'string',
   ],
   ```
   Add it after the existing properties (after 'og_image').

2. In `sanitize()` method, add sanitization for schema_type:
   ```php
   $clean['schema_type'] = isset( $value['schema_type'] ) ? sanitize_text_field( $value['schema_type'] ) : '';
   ```
   Add it after the og_image sanitization.

3. In `save_meta()` method (for classic editor), add:
   ```php
   'schema_type' => isset( $_POST['SAMAN_SEO_schema_type'] ) ? sanitize_text_field( wp_unslash( $_POST['SAMAN_SEO_schema_type'] ) ) : '',
   ```
   Add it to the $data array.

This ensures schema_type is:
- Exposed via REST API for Gutenberg to read/write
- Properly sanitized on save
- Available in classic editor (future-proofing)

The Schema_Context::determine_schema_type() already reads from meta['schema_type'] (line 146-148), so no changes needed there.
  </action>
  <verify>
Check file syntax:
```bash
php -l includes/class-saman-seo-service-post-meta.php
```

Verify schema_type appears in the schema properties array and sanitize method.
  </verify>
  <done>
- schema_type field added to register_meta() schema properties
- schema_type sanitization added to sanitize() method
- schema_type handling added to save_meta() for classic editor
  </done>
</task>

</tasks>

<verification>
1. PHP syntax check passes for both modified files
2. Schema_Preview_Controller extends REST_Controller
3. Controller uses Schema_Context::from_post() and Schema_Graph_Manager::build()
4. Post_Meta schema includes schema_type property
5. Admin_V2 registers Schema_Preview controller
</verification>

<success_criteria>
- REST endpoint POST /saman-seo/v1/schema/preview/{post_id} is registered
- Endpoint returns JSON-LD graph when called with valid post_id
- schema_type can be saved via REST API to _SAMAN_SEO_meta
- Schema_Context respects schema_type override from API request
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-ui/05-01-SUMMARY.md`
</output>
