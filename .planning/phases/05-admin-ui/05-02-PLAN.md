---
phase: 05-admin-ui
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src-v2/editor/components/SchemaTypeSelector.js
  - src-v2/editor/components/SchemaPreview.js
  - src-v2/editor/hooks/useSchemaPreview.js
  - src-v2/editor/components/SEOPanel.js
  - src-v2/editor/index.js
  - src-v2/editor/editor.css
autonomous: false

must_haves:
  truths:
    - "User can see a Schema tab in the editor sidebar"
    - "User can select a schema type from dropdown in Schema tab"
    - "User can see live JSON-LD preview that updates when content changes"
    - "Selected schema type is saved when post is saved"
  artifacts:
    - path: "src-v2/editor/components/SchemaTypeSelector.js"
      provides: "Schema type dropdown component"
      exports: ["SchemaTypeSelector"]
    - path: "src-v2/editor/components/SchemaPreview.js"
      provides: "JSON-LD preview panel component"
      exports: ["SchemaPreview"]
    - path: "src-v2/editor/hooks/useSchemaPreview.js"
      provides: "Hook for fetching preview with debounce"
      exports: ["useSchemaPreview"]
    - path: "src-v2/editor/components/SEOPanel.js"
      provides: "SEO panel with Schema tab"
      contains: "schema"
  key_links:
    - from: "src-v2/editor/components/SEOPanel.js"
      to: "SchemaTypeSelector"
      via: "import and render"
      pattern: "import.*SchemaTypeSelector"
    - from: "src-v2/editor/hooks/useSchemaPreview.js"
      to: "/saman-seo/v1/schema/preview"
      via: "apiFetch"
      pattern: "apiFetch.*schema/preview"
    - from: "src-v2/editor/index.js"
      to: "seoMeta.schema_type"
      via: "state management"
      pattern: "schema_type"
---

<objective>
Add Schema tab to editor sidebar with schema type selector and live JSON-LD preview.

Purpose: Enable users to configure and preview schema markup directly in the post editor
Output: Schema tab in SEOPanel with type selector dropdown and real-time JSON-LD preview
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-ui/05-RESEARCH.md
@.planning/phases/05-admin-ui/05-01-SUMMARY.md

@src-v2/editor/index.js
@src-v2/editor/components/SEOPanel.js
@src-v2/editor/components/SearchPreview.js
@src-v2/editor/editor.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSchemaPreview hook</name>
  <files>src-v2/editor/hooks/useSchemaPreview.js</files>
  <action>
Create `src-v2/editor/hooks/useSchemaPreview.js`:

```javascript
/**
 * Hook for fetching schema preview with debounce.
 */

import { useState, useEffect, useRef } from '@wordpress/element';
import apiFetch from '@wordpress/api-fetch';

/**
 * Fetch JSON-LD preview from REST API with debounce.
 *
 * @param {number} postId      - The post ID to preview.
 * @param {string} schemaType  - The schema type to preview.
 * @param {Array}  dependencies - Additional dependencies to trigger refetch.
 * @returns {{ preview: object|null, loading: boolean, error: string|null }}
 */
const useSchemaPreview = (postId, schemaType, dependencies = []) => {
    const [preview, setPreview] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const timeoutRef = useRef(null);
    const abortControllerRef = useRef(null);

    useEffect(() => {
        // Don't fetch if no post ID (unsaved post)
        if (!postId) {
            setPreview(null);
            return;
        }

        // Clear previous timeout
        if (timeoutRef.current) {
            clearTimeout(timeoutRef.current);
        }

        // Abort previous request
        if (abortControllerRef.current) {
            abortControllerRef.current.abort();
        }

        // Debounce: wait 500ms after last change
        timeoutRef.current = setTimeout(() => {
            setLoading(true);
            setError(null);

            abortControllerRef.current = new AbortController();

            apiFetch({
                path: `/saman-seo/v1/schema/preview/${postId}`,
                method: 'POST',
                data: { schema_type: schemaType || '' },
                signal: abortControllerRef.current.signal,
            })
                .then((response) => {
                    if (response.success) {
                        setPreview(response.data.json_ld);
                    } else {
                        setError(response.message || 'Failed to load preview');
                    }
                })
                .catch((err) => {
                    // Ignore abort errors
                    if (err.name !== 'AbortError') {
                        setError(err.message || 'Failed to load preview');
                    }
                })
                .finally(() => setLoading(false));
        }, 500);

        return () => {
            if (timeoutRef.current) {
                clearTimeout(timeoutRef.current);
            }
            if (abortControllerRef.current) {
                abortControllerRef.current.abort();
            }
        };
    }, [postId, schemaType, ...dependencies]);

    return { preview, loading, error };
};

export default useSchemaPreview;
```

Key features:
- 500ms debounce to avoid API spam
- AbortController for cleanup on unmount
- Handles unsaved posts (no postId) gracefully
- Returns loading and error states for UI
  </action>
  <verify>
Verify hook file exists and has correct exports:
```bash
grep -n "useSchemaPreview" src-v2/editor/hooks/useSchemaPreview.js
```
  </verify>
  <done>
- useSchemaPreview.js exists in src-v2/editor/hooks/
- Hook accepts postId, schemaType, dependencies parameters
- Returns preview, loading, error state
- Uses 500ms debounce and AbortController
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SchemaTypeSelector and SchemaPreview components</name>
  <files>
    src-v2/editor/components/SchemaTypeSelector.js
    src-v2/editor/components/SchemaPreview.js
  </files>
  <action>
Create `src-v2/editor/components/SchemaTypeSelector.js`:

```javascript
/**
 * Schema Type Selector Component
 *
 * Dropdown for selecting schema type per post.
 */

import { SelectControl } from '@wordpress/components';
import { __ } from '@wordpress/i18n';

// Schema type options - should match backend registry
// These are the content-focused types relevant for posts/pages
const schemaTypeOptions = [
    { value: '', label: __('Use default', 'saman-seo') },
    { value: 'Article', label: __('Article', 'saman-seo') },
    { value: 'BlogPosting', label: __('Blog Posting', 'saman-seo') },
    { value: 'NewsArticle', label: __('News Article', 'saman-seo') },
];

const SchemaTypeSelector = ({ value, onChange, postType }) => {
    return (
        <div className="saman-seo-field">
            <SelectControl
                label={__('Schema Type', 'saman-seo')}
                value={value || ''}
                options={schemaTypeOptions}
                onChange={onChange}
                help={__('Override the default schema type for this post', 'saman-seo')}
            />
        </div>
    );
};

export default SchemaTypeSelector;
```

Create `src-v2/editor/components/SchemaPreview.js`:

```javascript
/**
 * Schema Preview Component
 *
 * Displays live JSON-LD preview with copy functionality.
 */

import { Button, Spinner } from '@wordpress/components';
import { __ } from '@wordpress/i18n';
import { useState } from '@wordpress/element';

const SchemaPreview = ({ jsonLd, loading, error }) => {
    const [copied, setCopied] = useState(false);

    const handleCopy = () => {
        const formatted = JSON.stringify(jsonLd, null, 2);
        navigator.clipboard.writeText(formatted).then(() => {
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
        });
    };

    if (loading) {
        return (
            <div className="saman-seo-schema-preview saman-seo-schema-preview--loading">
                <Spinner />
                <span>{__('Loading preview...', 'saman-seo')}</span>
            </div>
        );
    }

    if (error) {
        return (
            <div className="saman-seo-schema-preview saman-seo-schema-preview--error">
                <span className="saman-seo-schema-preview-error">{error}</span>
            </div>
        );
    }

    if (!jsonLd) {
        return (
            <div className="saman-seo-schema-preview saman-seo-schema-preview--empty">
                <p className="saman-seo-field-help">
                    {__('Save post to see schema preview', 'saman-seo')}
                </p>
            </div>
        );
    }

    const formatted = JSON.stringify(jsonLd, null, 2);

    return (
        <div className="saman-seo-schema-preview">
            <div className="saman-seo-schema-preview-header">
                <span className="saman-seo-section-label">
                    {__('JSON-LD Preview', 'saman-seo')}
                </span>
                <Button
                    variant="tertiary"
                    onClick={handleCopy}
                    className="saman-seo-schema-preview-copy"
                >
                    {copied ? __('Copied!', 'saman-seo') : __('Copy', 'saman-seo')}
                </Button>
            </div>
            <pre className="saman-seo-schema-preview-code">
                <code>{formatted}</code>
            </pre>
        </div>
    );
};

export default SchemaPreview;
```
  </action>
  <verify>
Verify both component files exist:
```bash
ls -la src-v2/editor/components/SchemaTypeSelector.js src-v2/editor/components/SchemaPreview.js
```
  </verify>
  <done>
- SchemaTypeSelector.js exists with SelectControl dropdown
- SchemaPreview.js exists with JSON preview and copy functionality
- Both components use WordPress component library
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Schema tab into SEOPanel</name>
  <files>
    src-v2/editor/components/SEOPanel.js
    src-v2/editor/index.js
    src-v2/editor/editor.css
  </files>
  <action>
Update `src-v2/editor/index.js`:

1. Add `schema_type: ''` to the initial seoMeta state object (around line 59-67)
2. In the useEffect that loads meta (around line 112-133), add:
   ```javascript
   schema_type: meta.schema_type || '',
   ```
3. In updateMeta callback (around line 169-191), ensure schema_type is included in metaForSave:
   ```javascript
   schema_type: newMeta.schema_type || '',
   ```

Update `src-v2/editor/components/SEOPanel.js`:

1. Add imports at top:
   ```javascript
   import SchemaTypeSelector from './SchemaTypeSelector';
   import SchemaPreview from './SchemaPreview';
   import useSchemaPreview from '../hooks/useSchemaPreview';
   ```

2. Add postType to props (already passed from index.js as `postType`)

3. Inside SEOPanel component, add the hook call after existing state declarations:
   ```javascript
   // Fetch schema preview with debounce
   const { preview: schemaPreview, loading: schemaLoading, error: schemaError } = useSchemaPreview(
       postId,
       seoMeta.schema_type,
       [postTitle, postContent]  // Refresh when content changes
   );
   ```

4. Add Schema tab button in the tabs section (after Social button, around line 201-208):
   ```javascript
   <button
       type="button"
       className={`saman-seo-tab ${activeTab === 'schema' ? 'active' : ''}`}
       onClick={() => setActiveTab('schema')}
   >
       Schema
   </button>
   ```

5. Add Schema tab content section (after Social tab section, before AI Generate Modal):
   ```javascript
   {/* Schema Tab */}
   {activeTab === 'schema' && (
       <div className="saman-seo-tab-content">
           <SchemaTypeSelector
               value={seoMeta.schema_type || ''}
               onChange={(value) => updateMeta('schema_type', value)}
               postType={postType}
           />
           <SchemaPreview
               jsonLd={schemaPreview}
               loading={schemaLoading}
               error={schemaError}
           />
       </div>
   )}
   ```

Update `src-v2/editor/editor.css` - add styles at the end:

```css
/* Schema Preview Styles */
.saman-seo-schema-preview {
    margin-top: 16px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: #f9f9f9;
}

.saman-seo-schema-preview--loading,
.saman-seo-schema-preview--empty {
    padding: 24px;
    text-align: center;
    color: #757575;
}

.saman-seo-schema-preview--loading .components-spinner {
    margin-bottom: 8px;
}

.saman-seo-schema-preview--error {
    padding: 16px;
    background: #fef2f2;
    border-color: #fca5a5;
}

.saman-seo-schema-preview-error {
    color: #b91c1c;
}

.saman-seo-schema-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid #e0e0e0;
    background: #fff;
}

.saman-seo-schema-preview-copy {
    font-size: 12px;
}

.saman-seo-schema-preview-code {
    margin: 0;
    padding: 12px;
    font-size: 11px;
    line-height: 1.5;
    max-height: 300px;
    overflow: auto;
    background: #1e1e1e;
    color: #d4d4d4;
    border-radius: 0 0 4px 4px;
}

.saman-seo-schema-preview-code code {
    white-space: pre;
    font-family: 'SF Mono', Monaco, 'Consolas', monospace;
}
```
  </action>
  <verify>
Build the editor assets:
```bash
cd "C:/Users/Juan/Local Sites/wp-seo-pilot/app/public/wp-content/plugins/saman-seo" && npm run build
```

Check for build errors. The build should complete without errors.
  </verify>
  <done>
- SEOPanel.js has Schema tab button and content section
- index.js handles schema_type in state and persistence
- Schema preview styles added to editor.css
- Build completes without errors
  </done>
</task>

</tasks>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Schema tab in Gutenberg editor sidebar with type selector and live JSON-LD preview</what-built>
  <how-to-verify>
1. Go to WordPress admin, edit any post
2. Open the Saman SEO sidebar (click SEO icon in top-right toolbar)
3. Click the "Schema" tab
4. Verify: Schema Type dropdown is visible with options (Use default, Article, Blog Posting, News Article)
5. Change the schema type selection
6. Verify: JSON-LD preview panel updates (may show loading spinner briefly)
7. Save the post
8. Reload the page
9. Verify: Selected schema type is preserved
10. Edit post title or content
11. Verify: Preview updates automatically after ~500ms
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<verification>
1. npm run build completes without errors
2. Schema tab appears in SEOPanel alongside General, Analysis, Advanced, Social
3. SchemaTypeSelector shows dropdown with schema type options
4. SchemaPreview fetches and displays JSON-LD from REST endpoint
5. Preview updates when schema_type changes or content changes
6. schema_type is saved to post meta and persists across page reloads
</verification>

<success_criteria>
- Schema tab is visible and functional in editor sidebar
- User can select schema type from dropdown
- Live JSON-LD preview displays and updates in real-time
- Selected schema type persists when post is saved
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-ui/05-02-SUMMARY.md`
</output>
