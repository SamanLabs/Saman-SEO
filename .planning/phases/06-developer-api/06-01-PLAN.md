---
phase: 06-developer-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-saman-seo-plugin.php
  - includes/Schema/class-abstract-schema.php
autonomous: true

must_haves:
  truths:
    - "Third-party plugin can register custom schema type via saman_seo_register_schema_type action"
    - "Developer can modify schema fields via saman_seo_schema_{type}_fields filter"
  artifacts:
    - path: "includes/class-saman-seo-plugin.php"
      provides: "saman_seo_register_schema_type action hook"
      contains: "do_action( 'saman_seo_register_schema_type'"
    - path: "includes/Schema/class-abstract-schema.php"
      provides: "saman_seo_schema_{type}_fields filter hook"
      contains: "apply_filters.*_fields"
  key_links:
    - from: "includes/class-saman-seo-plugin.php"
      to: "Schema_Registry::instance()"
      via: "action passes registry to callbacks"
      pattern: "do_action.*saman_seo_register_schema_type.*\\$registry"
    - from: "includes/Schema/class-abstract-schema.php"
      to: "Schema_Graph_Manager::build()"
      via: "fields filter applied before output filter"
      pattern: "apply_filters.*_fields.*\\$this->context"
---

<objective>
Add the missing developer API hooks: registration action and fields filter.

Purpose: Enable third-party developers to extend the schema system by registering custom schema types and modifying schema fields before generation.

Output: Two new hooks in the codebase - `saman_seo_register_schema_type` action in Plugin::boot() and `saman_seo_schema_{type}_fields` filter in Abstract_Schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-developer-api/06-RESEARCH.md

# Existing files to modify
@includes/class-saman-seo-plugin.php
@includes/Schema/class-abstract-schema.php
@includes/Schema/class-schema-registry.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add saman_seo_register_schema_type action hook</name>
  <files>includes/class-saman-seo-plugin.php</files>
  <action>
In Plugin::boot(), add the registration action hook AFTER all core schema registrations (after the breadcrumb registration at line ~135) but BEFORE the service registrations.

Add this code block with proper PHPDoc:

```php
/**
 * Fires after core schema types are registered.
 *
 * Third-party developers use this hook to register custom schema types
 * that will be included in the JSON-LD @graph output. Custom schemas must
 * extend Abstract_Schema and implement the required methods.
 *
 * @since 1.0.0
 *
 * @param Schema_Registry $registry The schema registry singleton instance.
 *                                  Use $registry->register() to add types.
 *
 * @example
 * // Register a custom schema type
 * add_action( 'saman_seo_register_schema_type', function( $registry ) {
 *     $registry->register( 'myslug', MySchema::class, [
 *         'label'    => 'My Schema',
 *         'priority' => 15,
 *     ]);
 * });
 */
do_action( 'saman_seo_register_schema_type', $registry );
```

This follows the WordPress Hooks API pattern and provides the registry instance to callbacks so they can call $registry->register() directly.
  </action>
  <verify>
Grep for "saman_seo_register_schema_type" in the plugin file to confirm the hook exists.
Run `php -l includes/class-saman-seo-plugin.php` to verify no syntax errors.
  </verify>
  <done>
The `saman_seo_register_schema_type` action fires after core registrations with registry as parameter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add saman_seo_schema_{type}_fields filter hook</name>
  <files>includes/Schema/class-abstract-schema.php</files>
  <action>
Add a protected method `apply_fields_filter()` to Abstract_Schema that applies the fields filter. This method will be called by concrete schema classes in their generate() methods.

Add this method to Abstract_Schema:

```php
/**
 * Apply the fields filter to allow modification of schema data.
 *
 * Call this method in generate() after building the base schema array
 * but before returning. Allows developers to add or modify fields.
 *
 * @since 1.0.0
 *
 * @param array $data The schema data array to filter.
 * @return array The filtered schema data.
 */
protected function apply_fields_filter( array $data ): array {
    $type = $this->get_type();

    // Handle array types (use first element for filter name).
    if ( is_array( $type ) ) {
        $type = reset( $type );
    }

    $slug = strtolower( $type );

    /**
     * Filters the schema fields before final output.
     *
     * Allows modification of the schema data array before it's added
     * to the graph. Use this to add custom fields or modify existing ones.
     *
     * @since 1.0.0
     *
     * @param array          $data    The schema data array.
     * @param Schema_Context $context The current schema context.
     */
    return apply_filters( "saman_seo_schema_{$slug}_fields", $data, $this->context );
}
```

NOTE: This method is OPTIONAL for concrete classes to call. The existing `saman_seo_schema_{slug}_output` filter in Graph_Manager already provides modification capability. This new filter provides an alternative hook point specifically for the base class pattern, but does NOT require modifying all concrete schema classes.

The documentation will explain both approaches:
1. Use `_fields` filter via apply_fields_filter() in custom schemas
2. Use `_output` filter (existing) to modify any schema after generation
  </action>
  <verify>
Grep for "apply_fields_filter" and "_fields" in Abstract_Schema.
Run `php -l includes/Schema/class-abstract-schema.php` to verify no syntax errors.
  </verify>
  <done>
The `apply_fields_filter()` method exists and applies the `saman_seo_schema_{type}_fields` filter.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "saman_seo_register_schema_type" includes/` shows the action in Plugin.php
2. `grep -r "saman_seo_schema_.*_fields" includes/` shows the filter pattern in Abstract_Schema
3. Both files pass PHP lint check
4. Plugin still loads without errors (existing functionality preserved)
</verification>

<success_criteria>
- saman_seo_register_schema_type action exists in Plugin::boot() after core registrations
- saman_seo_schema_{type}_fields filter method exists in Abstract_Schema
- Both hooks have proper PHPDoc with @since, @param, and @example
- No syntax errors, plugin loads correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-developer-api/06-01-SUMMARY.md`
</output>
