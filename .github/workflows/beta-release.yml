name: Create Beta Release

on:
  # Tag-based trigger for beta versions
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+'
    branches:
      - dev
      - beta
      - develop

  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Full version (e.g., 2.0.0-beta.1). Leave empty for auto-increment.'
        required: false
      description:
        description: 'Beta release description'
        required: false
        default: 'Beta release for testing'

permissions:
  contents: write

jobs:
  beta-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: get_version
        run: |
          # If triggered by tag push
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}
            echo "Source: tag push"

          # If manual trigger with version specified
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Source: manual input"

          # Auto-determine from plugin file and increment beta
          else
            BASE_VERSION=$(grep -oP "^\s*\*\s*Version:\s*\K[\d.]+" saman-seo.php | head -1)

            # Find highest existing beta for this version
            EXISTING_BETAS=$(git tag -l "v${BASE_VERSION}-beta.*" | grep -oP "beta\.\K\d+" | sort -n | tail -1)
            if [ -z "$EXISTING_BETAS" ]; then
              BETA_NUM=1
            else
              BETA_NUM=$((EXISTING_BETAS + 1))
            fi

            VERSION="${BASE_VERSION}-beta.${BETA_NUM}"
            echo "Source: auto-increment (base: $BASE_VERSION, beta: $BETA_NUM)"
          fi

          ZIP_VERSION=$(echo $VERSION | sed 's/\./-/g')
          TAG="v$VERSION"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "zip_version=$ZIP_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Final version: $VERSION"

      - name: Check if tag exists (for non-tag triggers)
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          if git rev-parse "${{ steps.get_version.outputs.tag }}" >/dev/null 2>&1; then
            echo "::error::Tag ${{ steps.get_version.outputs.tag }} already exists!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      - name: Create plugin zip
        run: |
          VERSION=${{ steps.get_version.outputs.zip_version }}

          mkdir -p saman-seo

          # Copy only production files (whitelist approach)
          cp -r assets saman-seo/
          cp -r build saman-seo/
          cp -r includes saman-seo/
          cp -r languages saman-seo/ 2>/dev/null || mkdir -p saman-seo/languages
          cp saman-seo.php saman-seo/
          cp readme.txt saman-seo/ 2>/dev/null || true
          cp LICENSE saman-seo/ 2>/dev/null || true

          # Remove any dev/config files that might have snuck in
          find saman-seo -name "*.md" ! -name "readme.txt" -type f -delete 2>/dev/null || true
          find saman-seo -name ".git*" -delete 2>/dev/null || true
          find saman-seo -name ".claude*" -delete 2>/dev/null || true
          find saman-seo -name ".vscode*" -delete 2>/dev/null || true
          find saman-seo -name ".DS_Store" -delete 2>/dev/null || true
          find saman-seo -name "*.log" -delete 2>/dev/null || true
          find saman-seo -name ".planning" -type d -exec rm -rf {} + 2>/dev/null || true
          find saman-seo -name "docs" -type d -exec rm -rf {} + 2>/dev/null || true
          find saman-seo -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true

          zip -r saman-seo-$VERSION.zip saman-seo
          rm -rf saman-seo

          echo "Created saman-seo-$VERSION.zip"

      - name: Prepare release notes
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          DESCRIPTION="${{ github.event.inputs.description }}"
          if [ -z "$DESCRIPTION" ]; then
            DESCRIPTION="Beta release for testing new features."
          fi

          {
            echo "## Beta Release $VERSION"
            echo ""
            echo "⚠️ **This is a pre-release version for testing purposes.**"
            echo ""
            echo "### Description"
            echo "$DESCRIPTION"
            echo ""
            echo "### How to Install"
            echo "1. Go to **SEO Pilot → More**"
            echo "2. Click **Check for Updates** to find this beta"
            echo "3. Click **Update** to install"
            echo ""
            echo "### Feedback"
            echo "Please report any issues at: https://github.com/${{ github.repository }}/issues"
            echo ""
            echo "---"
            echo "Commit: \`${{ github.sha }}\`"
          } > release_notes.md

          cat release_notes.md

      - name: Create Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Saman SEO ${{ steps.get_version.outputs.version }} (Beta)
          body_path: release_notes.md
          draft: false
          prerelease: true
          files: saman-seo-${{ steps.get_version.outputs.zip_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Beta Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.get_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Zip:** saman-seo-${{ steps.get_version.outputs.zip_version }}.zip" >> $GITHUB_STEP_SUMMARY
